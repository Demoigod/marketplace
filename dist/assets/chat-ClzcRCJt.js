import{a as m,i as g,g as u,s as r}from"./navbar-CJGh-4aH.js";/* empty css               */let a=null,i=null;document.addEventListener("DOMContentLoaded",async()=>{if(await m(),!await g()){window.location.href="index.html";return}if(i=await u(),a=new URLSearchParams(window.location.search).get("conversation_id"),!a){window.location.href="index.html";return}await v(),await f(),c(),document.getElementById("messageForm").addEventListener("submit",h),document.getElementById("backBtn").addEventListener("click",()=>{window.history.back()})});async function v(){try{const{data:e,error:t}=await r.from("conversations").select("*").eq("id",a).single();if(t)throw t;const s=e.user1_id===i.id?e.user2_id:e.user1_id,{data:n,error:o}=await r.from("users").select("name").eq("id",s).single();o?(console.warn("Could not load partner name, using fallback"),document.getElementById("chatPartnerName").textContent="Chat Partner"):document.getElementById("chatPartnerName").textContent=n.name||"Chat Partner"}catch(e){throw console.error("Error loading conversation details:",e.message),document.getElementById("messagesList").innerHTML='<div class="error-state">Conversation not found or access denied.</div>',e}}async function f(){const e=document.getElementById("messagesList");try{const{data:t,error:s}=await r.from("messages").select("*").eq("conversation_id",a).order("created_at",{ascending:!0});if(s)throw s;e.innerHTML="",t.length===0?e.innerHTML='<div class="empty-state">No messages yet. Say hello!</div>':t.forEach(n=>d(n)),l()}catch(t){e.innerHTML=`<div class="error-state">Error loading messages: ${t.message}</div>`}}function c(){console.log(`Subscribing to messages for conversation: ${a}`),r.channel(`chat:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${a}`},e=>{console.log("New message received via Realtime:",e.new.body),d(e.new),l()}).subscribe(e=>{console.log(`Realtime subscription status: ${e}`),e==="SUBSCRIBED"&&console.log("Successfully connected to real-time messaging channel."),e==="CHANNEL_ERROR"&&(console.error("Failed to connect to real-time channel. Retrying in 3 seconds..."),setTimeout(c,3e3))})}async function h(e){e.preventDefault();const t=document.getElementById("messageInput"),s=t.value.trim();if(!(!s||!a)){t.value="";try{const{error:n}=await r.from("messages").insert([{conversation_id:a,sender_id:i.id,body:s}]);if(n)throw n}catch(n){alert("Failed to send message: "+n.message),t.value=s}}}function d(e){const t=document.getElementById("messagesList"),s=e.sender_id===i.id,n=t.querySelector(".empty-state");n&&n.remove();const o=document.createElement("div");o.className=`message-bubble ${s?"sent":"received"}`,o.innerHTML=`
        <div class="message-content">${y(e.body)}</div>
        <div class="message-time">${new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</div>
    `,t.appendChild(o)}function l(){const e=document.getElementById("messagesList");e.scrollTop=e.scrollHeight}function y(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}
