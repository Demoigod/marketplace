import{i as v,a as f,g as y,s as a}from"./navbar-DPq7TFUX.js";/* empty css               */let r=null,o=null,c=null;document.addEventListener("DOMContentLoaded",async()=>{if(await v(),!await f()){window.location.href="index.html";return}if(r=await y(),!r)return;const e=new URLSearchParams(window.location.search),t=e.get("seller_id")||e.get("partner_id");if(t){const s=await p(t);s&&(o=s,await l(s))}await h(),B()});async function p(e){if(e===r.id)return alert("You cannot message yourself!"),null;const[t,s]=[r.id,e].sort();try{const{data:n,error:i}=await a.from("conversations").select("id").eq("user1_id",t).eq("user2_id",s).maybeSingle();if(n)return n.id;const{data:g,error:d}=await a.from("conversations").insert([{user1_id:t,user2_id:s}]).select("id").single();if(d)throw d;return g.id}catch(n){return console.error("Error getting/creating conversation:",n),null}}async function h(){const e=document.getElementById("conversationsContainer");try{const{data:t,error:s}=await a.from("conversations").select(`
                id,
                created_at,
                user1:users!user1_id (id, name),
                user2:users!user2_id (id, name)
            `).or(`user1_id.eq.${r.id},user2_id.eq.${r.id}`).order("created_at",{ascending:!1});if(s)throw s;_(t)}catch(t){console.error("Error loading conversations:",t),e.innerHTML='<p class="error-msg">Failed to load conversations.</p>'}}async function l(e){o=e,document.getElementById("emptyChatState").style.display="none",document.getElementById("activeChatContainer").style.display="flex";const t=document.getElementById("messagesList");t.innerHTML='<div class="loading-messages">Loading messages...</div>',await L(e),w(e),M(e)}async function L(e){try{const{data:t,error:s}=await a.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(s)throw s;C(t),m()}catch(t){console.error("Error fetching history:",t)}}async function E(e){if(!(!o||!e.trim()))try{const{error:t}=await a.from("messages").insert([{conversation_id:o,sender_id:r.id,body:e}]);if(t)throw t}catch(t){console.error("Error sending message:",t),alert("Failed to send message.")}}function w(e){c&&a.removeChannel(c),c=a.channel(`chat:${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},t=>{b(t.new)}).subscribe()}function _(e){const t=document.getElementById("conversationsContainer");if(!e.length){t.innerHTML='<p class="empty-msg">No conversations yet.</p>';return}t.innerHTML=e.map(s=>{const n=s.user1.id===r.id?s.user2:s.user1;return`
            <div class="conversation-item ${s.id===o?"active":""}" data-id="${s.id}">
                <div class="conversation-info">
                    <span class="partner-name">${n.name||"Anonymous"}</span>
                    <span class="last-activity">${new Date(s.created_at).toLocaleDateString()}</span>
                </div>
            </div>
        `}).join(""),t.querySelectorAll(".conversation-item").forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.id;l(n),t.querySelectorAll(".conversation-item").forEach(i=>i.classList.remove("active")),s.classList.add("active")})})}function C(e){const t=document.getElementById("messagesList");t.innerHTML=e.map(s=>u(s)).join("")}function b(e){const t=document.getElementById("messagesList");if(document.querySelector(`[data-msg-id="${e.id}"]`))return;const s=document.createElement("div");s.innerHTML=u(e),t.appendChild(s.firstElementChild),m()}function u(e){const t=e.sender_id===r.id,s=new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`
        <div class="message ${t?"sent":"received"}" data-msg-id="${e.id}">
            <div class="message-body">${T(e.body)}</div>
            <span class="message-time">${s}</span>
        </div>
    `}async function M(e){const{data:t}=await a.from("conversations").select("user1:users!user1_id (name), user2:users!user2_id (name)").eq("id",e).single()}function B(){const e=document.getElementById("messageForm"),t=document.getElementById("messageInput");e.addEventListener("submit",async n=>{n.preventDefault();const i=t.value;t.value="",await E(i)});const s=document.getElementById("backToConversations");s&&s.addEventListener("click",()=>{document.querySelector(".message-page-container").classList.remove("mobile-chat-active")})}function m(){const e=document.getElementById("messagesList");e.scrollTop=e.scrollHeight}function T(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}
