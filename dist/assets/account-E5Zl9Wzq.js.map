{"version":3,"file":"account-E5Zl9Wzq.js","sources":["../../account.js","../../account.html?html-proxy&index=3.js"],"sourcesContent":["import { supabase } from './supabase-config.js';\r\nimport { isLoggedIn, logoutUser, getCurrentUser } from './auth.js';\r\nimport './admin.js'; // Force inclusion of admin logic (UI injection)\r\n\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n    // account.html is now handled by the unified syncProfileUI() in admin.js\r\n    console.log('Account page specialized logic ready.');\r\n    setupEventListeners();\r\n});\r\n\r\nfunction setupEventListeners() {\r\n    const logoutBtn = document.getElementById('sidebarLogout');\r\n    if (logoutBtn) {\r\n        logoutBtn.addEventListener('click', async (e) => {\r\n            e.preventDefault();\r\n            if (confirm('Are you sure you want to logout?')) {\r\n                await logoutUser();\r\n                window.location.href = 'index.html';\r\n            }\r\n        });\r\n    }\r\n\r\n    // Avatar Upload Logic\r\n    const avatarInput = document.getElementById('avatarInput');\r\n    if (avatarInput) {\r\n        avatarInput.addEventListener('change', async (e) => {\r\n            console.log('Avatar input changed');\r\n            const file = e.target.files[0];\r\n            if (!file) {\r\n                console.log('No file selected');\r\n                return;\r\n            }\r\n            alert('File selected: ' + file.name + ' (' + Math.round(file.size / 1024) + 'KB). Starting upload...');\r\n\r\n            // Basic validation\r\n            if (file.size > 2 * 1024 * 1024) { // 2MB limit\r\n                alert('File size must be less than 2MB');\r\n                return;\r\n            }\r\n\r\n            try {\r\n                // Show uploading state (optional improvement: replace icon with spinner)\r\n                const overlay = document.querySelector('.avatar-edit-overlay');\r\n                const originalContent = overlay.innerHTML;\r\n                overlay.innerHTML = '<span style=\"font-size: 10px;\">‚è≥</span>';\r\n\r\n                const { data: { user } } = await supabase.auth.getUser();\r\n                if (!user) throw new Error('Not authenticated');\r\n\r\n                const fileExt = file.name.split('.').pop();\r\n                const fileName = `${Date.now()}.${fileExt}`;\r\n                const filePath = `${user.id}/${fileName}`;\r\n\r\n                // 1. Upload to Storage\r\n                const { error: uploadError } = await supabase.storage\r\n                    .from('avatars')\r\n                    .upload(filePath, file, { upsert: true });\r\n\r\n                if (uploadError) throw uploadError;\r\n\r\n                // 2. Get Public URL\r\n                const { data: { publicUrl } } = supabase.storage\r\n                    .from('avatars')\r\n                    .getPublicUrl(filePath);\r\n\r\n                // 3. Update Profile\r\n                const { error: updateError } = await supabase\r\n                    .from('profiles')\r\n                    .update({ avatar_url: publicUrl })\r\n                    .eq('id', user.id);\r\n\r\n                if (updateError) throw updateError;\r\n\r\n                // 4. Refresh UI\r\n                if (window.syncProfileUI) {\r\n                    // Update the local user object for immediate feedback if needed, \r\n                    // but syncProfileUI usually fetches fresh data or we can pass the partial update.\r\n                    const updatedUser = { ...user, avatar_url: publicUrl };\r\n                    // We need to re-fetch to get the full profile merged data usually, \r\n                    // or just let syncProfileUI handle the fetch if called without args.\r\n                    // For speed, let's call it and also manually set DOM for instant feel.\r\n                    document.getElementById('profileAvatar').src = publicUrl;\r\n                    document.getElementById('topNavAvatar').src = publicUrl;\r\n                    alert('Profile picture updated!');\r\n                } else {\r\n                    window.location.reload();\r\n                }\r\n\r\n                overlay.innerHTML = originalContent;\r\n\r\n            } catch (err) {\r\n                console.error('Avatar upload failed:', err);\r\n                alert('Failed to update profile picture: ' + err.message);\r\n                document.querySelector('.avatar-edit-overlay').innerHTML = `\r\n                    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" stroke-width=\"2\">\r\n                        <path d=\"M12 20h9\"></path>\r\n                        <path d=\"M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z\"></path>\r\n                    </svg>\r\n                `;\r\n            }\r\n        });\r\n    }\r\n\r\n    // Verify Initial Username State\r\n    const usernameInput = document.getElementById('username');\r\n    const saveBtn = document.getElementById('saveProfileBtn');\r\n    const feedback = document.getElementById('usernameFeedback');\r\n    let originalUsername = '';\r\n\r\n    if (usernameInput && saveBtn && feedback) {\r\n\r\n        // Remove readonly if it was stuck (though HTML update should handle it)\r\n        usernameInput.removeAttribute('readonly');\r\n        usernameInput.style.cursor = 'text';\r\n        usernameInput.style.backgroundColor = 'white';\r\n\r\n        usernameInput.addEventListener('focus', () => {\r\n            if (!originalUsername) originalUsername = usernameInput.value;\r\n        });\r\n\r\n        usernameInput.addEventListener('input', (e) => {\r\n            const val = e.target.value.trim();\r\n            const valid = /^[a-zA-Z0-9_]{3,20}$/.test(val);\r\n\r\n            if (val === originalUsername) {\r\n                saveBtn.style.opacity = '0.5';\r\n                saveBtn.style.pointerEvents = 'none';\r\n                feedback.textContent = '';\r\n                usernameInput.style.borderColor = '#d1d5db';\r\n            } else if (!valid) {\r\n                saveBtn.style.opacity = '0.5';\r\n                saveBtn.style.pointerEvents = 'none';\r\n                feedback.textContent = 'Username must be 3-20 chars, alphanumeric or underscore.';\r\n                feedback.style.color = 'red';\r\n                usernameInput.style.borderColor = 'red';\r\n            } else {\r\n                saveBtn.style.opacity = '1';\r\n                saveBtn.style.pointerEvents = 'auto';\r\n                feedback.textContent = 'Looks good! Click save to check availability.';\r\n                feedback.style.color = 'green';\r\n                usernameInput.style.borderColor = 'green';\r\n            }\r\n        });\r\n\r\n        saveBtn.addEventListener('click', async () => {\r\n            const newUsername = usernameInput.value.trim();\r\n            saveBtn.textContent = 'Saving...';\r\n            saveBtn.disabled = true;\r\n\r\n            try {\r\n                const { data: { user } } = await supabase.auth.getUser();\r\n                if (!user) throw new Error('Not authenticated');\r\n\r\n                const { error } = await supabase\r\n                    .from('profiles')\r\n                    .update({ username: newUsername })\r\n                    .eq('id', user.id);\r\n\r\n                if (error) {\r\n                    if (error.code === '23505') { // Unique violation\r\n                        throw new Error('This username is already taken.');\r\n                    }\r\n                    throw error;\r\n                }\r\n\r\n                alert('Username updated successfully!');\r\n                originalUsername = newUsername; // Sync state\r\n                saveBtn.textContent = 'Saved';\r\n                setTimeout(() => {\r\n                    saveBtn.textContent = 'Save Changes';\r\n                    saveBtn.style.opacity = '0.5';\r\n                    saveBtn.style.pointerEvents = 'none';\r\n                }, 2000);\r\n\r\n                if (window.syncProfileUI) {\r\n                    document.getElementById('profileFullName').textContent = newUsername;\r\n                    document.getElementById('userName').textContent = newUsername;\r\n                }\r\n\r\n            } catch (err) {\r\n                console.error('Update failed:', err);\r\n                feedback.textContent = err.message;\r\n                feedback.style.color = 'red';\r\n                usernameInput.style.borderColor = 'red';\r\n                saveBtn.textContent = 'Save Changes';\r\n                saveBtn.disabled = false;\r\n            }\r\n        });\r\n    }\r\n}\r\n","\n        import { getCurrentUser } from './auth.js';\n\n        document.addEventListener('DOMContentLoaded', async () => {\n            const user = await getCurrentUser();\n            if (user) {\n                const roleBadge = document.getElementById('detailsRoleBadge');\n                const sellerStatusCard = document.getElementById('sellerStatusCard');\n                const becomeSellerBtn = document.getElementById('becomeSellerBtn');\n                const sellerStatusText = document.getElementById('sellerStatusText');\n\n                if (roleBadge) {\n                    roleBadge.textContent = user.role === 'seller' ? 'Verified Seller' : 'Student / Buyer';\n                    roleBadge.className = user.role === 'seller' ? 'badge success' : 'badge';\n                }\n\n                if (sellerStatusCard) {\n                    if (user.role === 'seller') {\n                        sellerStatusText.textContent = \"You are a verified seller. You have full access to the dashboard.\";\n                        becomeSellerBtn.style.display = 'none';\n                        // Optional: Add a \"Go to Dashboard\" button here instead\n                    } else {\n                        sellerStatusText.textContent = \"You are currently a buyer. Verify your student status to start selling items.\";\n                        becomeSellerBtn.style.display = 'block';\n                    }\n                }\n            }\n        });\n    "],"names":["setupEventListeners","logoutBtn","e","logoutUser","avatarInput","file","overlay","originalContent","user","supabase","fileExt","fileName","filePath","uploadError","publicUrl","updateError","updatedUser","err","usernameInput","saveBtn","feedback","originalUsername","val","valid","newUsername","error","getCurrentUser","roleBadge","sellerStatusCard","becomeSellerBtn","sellerStatusText"],"mappings":"6GAIA,SAAS,iBAAiB,mBAAoB,SAAY,CAEtD,QAAQ,IAAI,uCAAuC,EACnDA,GACJ,CAAC,EAED,SAASA,GAAsB,CAC3B,MAAMC,EAAY,SAAS,eAAe,eAAe,EACrDA,GACAA,EAAU,iBAAiB,QAAS,MAAOC,GAAM,CAC7CA,EAAE,eAAc,EACZ,QAAQ,kCAAkC,IAC1C,MAAMC,EAAU,EAChB,OAAO,SAAS,KAAO,aAE/B,CAAC,EAIL,MAAMC,EAAc,SAAS,eAAe,aAAa,EACrDA,GACAA,EAAY,iBAAiB,SAAU,MAAOF,GAAM,CAChD,QAAQ,IAAI,sBAAsB,EAClC,MAAMG,EAAOH,EAAE,OAAO,MAAM,CAAC,EAC7B,GAAI,CAACG,EAAM,CACP,QAAQ,IAAI,kBAAkB,EAC9B,MACJ,CAIA,GAHA,MAAM,kBAAoBA,EAAK,KAAO,KAAO,KAAK,MAAMA,EAAK,KAAO,IAAI,EAAI,yBAAyB,EAGjGA,EAAK,KAAO,EAAI,KAAO,KAAM,CAC7B,MAAM,iCAAiC,EACvC,MACJ,CAEA,GAAI,CAEA,MAAMC,EAAU,SAAS,cAAc,sBAAsB,EACvDC,EAAkBD,EAAQ,UAChCA,EAAQ,UAAY,0CAEpB,KAAM,CAAE,KAAM,CAAE,KAAAE,CAAI,CAAE,EAAK,MAAMC,EAAS,KAAK,UAC/C,GAAI,CAACD,EAAM,MAAM,IAAI,MAAM,mBAAmB,EAE9C,MAAME,EAAUL,EAAK,KAAK,MAAM,GAAG,EAAE,MAC/BM,EAAW,GAAG,KAAK,IAAG,CAAE,IAAID,CAAO,GACnCE,EAAW,GAAGJ,EAAK,EAAE,IAAIG,CAAQ,GAGjC,CAAE,MAAOE,GAAgB,MAAMJ,EAAS,QACzC,KAAK,SAAS,EACd,OAAOG,EAAUP,EAAM,CAAE,OAAQ,EAAI,CAAE,EAE5C,GAAIQ,EAAa,MAAMA,EAGvB,KAAM,CAAE,KAAM,CAAE,UAAAC,CAAS,CAAE,EAAKL,EAAS,QACpC,KAAK,SAAS,EACd,aAAaG,CAAQ,EAGpB,CAAE,MAAOG,CAAW,EAAK,MAAMN,EAChC,KAAK,UAAU,EACf,OAAO,CAAE,WAAYK,EAAW,EAChC,GAAG,KAAMN,EAAK,EAAE,EAErB,GAAIO,EAAa,MAAMA,EAGvB,GAAI,OAAO,cAAe,CAGtB,MAAMC,EAAc,CAAE,GAAGR,EAAM,WAAYM,CAAS,EAIpD,SAAS,eAAe,eAAe,EAAE,IAAMA,EAC/C,SAAS,eAAe,cAAc,EAAE,IAAMA,EAC9C,MAAM,0BAA0B,CACpC,MACI,OAAO,SAAS,SAGpBR,EAAQ,UAAYC,CAExB,OAASU,EAAK,CACV,QAAQ,MAAM,wBAAyBA,CAAG,EAC1C,MAAM,qCAAuCA,EAAI,OAAO,EACxD,SAAS,cAAc,sBAAsB,EAAE,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,iBAM/D,CACJ,CAAC,EAIL,MAAMC,EAAgB,SAAS,eAAe,UAAU,EAClDC,EAAU,SAAS,eAAe,gBAAgB,EAClDC,EAAW,SAAS,eAAe,kBAAkB,EAC3D,IAAIC,EAAmB,GAEnBH,GAAiBC,GAAWC,IAG5BF,EAAc,gBAAgB,UAAU,EACxCA,EAAc,MAAM,OAAS,OAC7BA,EAAc,MAAM,gBAAkB,QAEtCA,EAAc,iBAAiB,QAAS,IAAM,CACrCG,IAAkBA,EAAmBH,EAAc,MAC5D,CAAC,EAEDA,EAAc,iBAAiB,QAAUhB,GAAM,CAC3C,MAAMoB,EAAMpB,EAAE,OAAO,MAAM,KAAI,EACzBqB,EAAQ,uBAAuB,KAAKD,CAAG,EAEzCA,IAAQD,GACRF,EAAQ,MAAM,QAAU,MACxBA,EAAQ,MAAM,cAAgB,OAC9BC,EAAS,YAAc,GACvBF,EAAc,MAAM,YAAc,WAC1BK,GAORJ,EAAQ,MAAM,QAAU,IACxBA,EAAQ,MAAM,cAAgB,OAC9BC,EAAS,YAAc,gDACvBA,EAAS,MAAM,MAAQ,QACvBF,EAAc,MAAM,YAAc,UAVlCC,EAAQ,MAAM,QAAU,MACxBA,EAAQ,MAAM,cAAgB,OAC9BC,EAAS,YAAc,2DACvBA,EAAS,MAAM,MAAQ,MACvBF,EAAc,MAAM,YAAc,MAQ1C,CAAC,EAEDC,EAAQ,iBAAiB,QAAS,SAAY,CAC1C,MAAMK,EAAcN,EAAc,MAAM,KAAI,EAC5CC,EAAQ,YAAc,YACtBA,EAAQ,SAAW,GAEnB,GAAI,CACA,KAAM,CAAE,KAAM,CAAE,KAAAX,CAAI,CAAE,EAAK,MAAMC,EAAS,KAAK,UAC/C,GAAI,CAACD,EAAM,MAAM,IAAI,MAAM,mBAAmB,EAE9C,KAAM,CAAE,MAAAiB,CAAK,EAAK,MAAMhB,EACnB,KAAK,UAAU,EACf,OAAO,CAAE,SAAUe,EAAa,EAChC,GAAG,KAAMhB,EAAK,EAAE,EAErB,GAAIiB,EACA,MAAIA,EAAM,OAAS,QACT,IAAI,MAAM,iCAAiC,EAE/CA,EAGV,MAAM,gCAAgC,EACtCJ,EAAmBG,EACnBL,EAAQ,YAAc,QACtB,WAAW,IAAM,CACbA,EAAQ,YAAc,eACtBA,EAAQ,MAAM,QAAU,MACxBA,EAAQ,MAAM,cAAgB,MAClC,EAAG,GAAI,EAEH,OAAO,gBACP,SAAS,eAAe,iBAAiB,EAAE,YAAcK,EACzD,SAAS,eAAe,UAAU,EAAE,YAAcA,EAG1D,OAASP,EAAK,CACV,QAAQ,MAAM,iBAAkBA,CAAG,EACnCG,EAAS,YAAcH,EAAI,QAC3BG,EAAS,MAAM,MAAQ,MACvBF,EAAc,MAAM,YAAc,MAClCC,EAAQ,YAAc,eACtBA,EAAQ,SAAW,EACvB,CACJ,CAAC,EAET,CC1LQ,SAAS,iBAAiB,mBAAoB,SAAY,CACtD,MAAMX,EAAO,MAAMkB,EAAc,EACjC,GAAIlB,EAAM,CACN,MAAMmB,EAAY,SAAS,eAAe,kBAAkB,EACtDC,EAAmB,SAAS,eAAe,kBAAkB,EAC7DC,EAAkB,SAAS,eAAe,iBAAiB,EAC3DC,EAAmB,SAAS,eAAe,kBAAkB,EAE/DH,IACAA,EAAU,YAAcnB,EAAK,OAAS,SAAW,kBAAoB,kBACrEmB,EAAU,UAAYnB,EAAK,OAAS,SAAW,gBAAkB,SAGjEoB,IACIpB,EAAK,OAAS,UACdsB,EAAiB,YAAc,oEAC/BD,EAAgB,MAAM,QAAU,SAGhCC,EAAiB,YAAc,gFAC/BD,EAAgB,MAAM,QAAU,SAG5C,CACJ,CAAC"}