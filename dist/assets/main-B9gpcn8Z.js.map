{"version":3,"file":"main-B9gpcn8Z.js","sources":["../../auth.js?v=nuclear-v1","../../index.html?html-proxy&index=0.js","../../supabase-config.js?v=fixed","../../auth.js?v=fixed","../../navbar.js?v=fixed","../../items.js?v=fixed","../../save-item.js?v=fixed","../../main.js?v=nuclear-v1"],"sourcesContent":["// ===== SUPABASE AUTHENTICATION SYSTEM =====\r\nimport { supabase } from './supabase-config.js'\r\n\r\n// Register new user\r\n// Register new user\r\nexport async function registerUser(email, password, userData) {\r\n    try {\r\n        const { firstName, lastName, username, phone, role } = userData;\r\n        // 1. Sign up user with Supabase Auth including metadata\r\n        const { data: authData, error: authError } = await supabase.auth.signUp({\r\n            email,\r\n            password,\r\n            options: {\r\n                data: {\r\n                    first_name: firstName,\r\n                    last_name: lastName,\r\n                    username: username,\r\n                    phone: phone,\r\n                    username: username,\r\n                    phone: phone,\r\n                    role: role || 'user'\r\n                }\r\n            }\r\n        });\r\n\r\n        if (authError) throw authError;\r\n\r\n        // If email confirmation is disabled, we get a session immediately\r\n        if (authData.session) {\r\n            return { success: true, message: 'Registration successful!', user: authData.user };\r\n        }\r\n\r\n        // Return success for email verification flow\r\n        return { success: true, message: 'Registration successful! Please check your email for verification.', user: authData.user };\r\n\r\n    } catch (error) {\r\n        console.error('Registration error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Login user\r\nexport async function loginUser(email, password) {\r\n    try {\r\n        const { data, error } = await supabase.auth.signInWithPassword({\r\n            email,\r\n            password,\r\n        });\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'Login successful', user: data.user };\r\n    } catch (error) {\r\n        console.error('Login error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Logout user\r\nexport async function logoutUser() {\r\n    try {\r\n        const { error } = await supabase.auth.signOut();\r\n        if (error) throw error;\r\n\r\n        // Clear any remaining local storage session items if needed\r\n        localStorage.removeItem('marketplace_session');\r\n\r\n        return { success: true, message: 'Logged out successfully' };\r\n    } catch (error) {\r\n        console.error('Logout error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Get current session\r\nexport async function getCurrentSession() {\r\n    const { data: { session }, error } = await supabase.auth.getSession();\r\n    if (error) {\r\n        console.error('Session error:', error.message);\r\n        return null;\r\n    }\r\n    return session;\r\n}\r\n\r\n// Check if user is logged in\r\nexport async function isLoggedIn() {\r\n    const session = await getCurrentSession();\r\n    return !!session;\r\n}\r\nexport const checkAuthStatus = isLoggedIn;\r\n\r\n// Get current user profile data\r\n// Get current user profile data\r\nexport async function getCurrentUser() {\r\n    try {\r\n        console.log(\"APP_DEBUG: getCurrentUser called\");\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) return null;\r\n\r\n        // Fetch additional profile data from profiles table\r\n        // Use maybeSingle() to avoid 406 error if profile doesn't exist yet\r\n        const { data: profile, error: profileError } = await supabase\r\n            .from('profiles')\r\n            .select('*, role')\r\n            .eq('id', user.id)\r\n            .maybeSingle();\r\n\r\n        let userProfile = { ...user };\r\n\r\n        if (profileError) {\r\n            console.warn('Error fetching profile:', profileError.message);\r\n            // Return auth user with default role if profile fetch fails\r\n            userProfile = { ...user, role: 'user' };\r\n        } else if (!profile) {\r\n            console.warn('Profile missing for user, using default');\r\n            userProfile = { ...user, role: 'user' };\r\n        } else {\r\n            userProfile = { ...user, ...profile };\r\n        }\r\n\r\n        // Fetch activity data with relational joins\r\n        // Initialize activity data with empty defaults\r\n        let purchases = [], listings = [], sellerListingsForSales = [], downloads = [], savedItems = [], uploadedResources = [];\r\n\r\n        try {\r\n            const results = await Promise.all([\r\n                supabase.from('purchases').select('*').eq('buyer_id', user.id).order('purchase_date', { ascending: false }).then(r => r.data || []),\r\n                supabase.from('market_listings').select('*').eq('seller_id', user.id).order('created_at', { ascending: false }).then(r => r.data || []),\r\n                supabase.from('market_listings').select('id').eq('seller_id', user.id).then(r => r.data || []),\r\n                supabase.from('downloads').select('*, resource:free_resources(*)').eq('user_id', user.id).order('download_date', { ascending: false }).then(r => r.data || []),\r\n                supabase.from('saved_items').select('*').eq('profile_id', user.id).then(r => r.data || []),\r\n                supabase.from('free_resources').select('*').eq('uploader_id', user.id).order('created_at', { ascending: false }).then(r => r.data || [])\r\n            ]);\r\n            [purchases, listings, sellerListingsForSales, downloads, savedItems, uploadedResources] = results;\r\n        } catch (e) {\r\n            console.warn('Error fetching supplementary activity data:', e.message);\r\n        }\r\n\r\n        // Post-process sales\r\n        let sales = [];\r\n        try {\r\n            if (sellerListingsForSales && sellerListingsForSales.length > 0) {\r\n                const myItemIds = sellerListingsForSales.map(l => l.id);\r\n                const { data: salesData } = await supabase\r\n                    .from('purchases')\r\n                    .select('*')\r\n                    .in('item_id', myItemIds);\r\n                sales = salesData || [];\r\n            }\r\n        } catch (e) {\r\n            console.warn('Could not fetch sales data:', e.message);\r\n        }\r\n\r\n        return {\r\n            ...userProfile,\r\n            id: user.id,\r\n            first_name: userProfile.first_name || user.user_metadata?.first_name || '',\r\n            last_name: userProfile.last_name || user.user_metadata?.last_name || '',\r\n            username: userProfile.username || user.user_metadata?.username || user.user_metadata?.name || 'User',\r\n            email: userProfile.email || user.email || '',\r\n            phone: userProfile.phone || user.user_metadata?.phone || '',\r\n            role: userProfile.role || 'user',\r\n            immutable_user_code: userProfile.immutable_user_code || null,\r\n            purchases: purchases,\r\n            listings: listings,\r\n            sales: sales,\r\n            downloads: downloads,\r\n            savedItems: savedItems,\r\n            uploadedResources: uploadedResources\r\n        };\r\n    } catch (error) {\r\n        console.error('Get user error:', error.message);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Update user profile\r\nexport async function updateUser(updates) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .update(updates)\r\n            .eq('id', user.id)\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'User updated', user: data };\r\n    } catch (error) {\r\n        console.error('Update user error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Add purchase to user\r\nexport async function addPurchase(item) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('purchases')\r\n            .insert([\r\n                {\r\n                    buyer_id: user.id,\r\n                    item_id: item.id,\r\n                    item_title: item.title,\r\n                    price: item.price,\r\n                    category: item.category\r\n                }\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'Purchase recorded', purchase: data };\r\n    } catch (error) {\r\n        console.error('Add purchase error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Add listing to seller\r\nexport async function addListing(item) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('market_listings')\r\n            .insert([\r\n                {\r\n                    ...item,\r\n                    seller_id: user.id, // Absolute identity linking\r\n                    status: 'active'\r\n                }\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'Listing added', listing: data };\r\n    } catch (error) {\r\n        console.error('Add listing error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Add download to user\r\nexport async function addDownload(resource) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('downloads')\r\n            .insert([\r\n                {\r\n                    user_id: user.id,\r\n                    resource_id: resource.id\r\n                }\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Increment download count on the resource\r\n        await supabase.rpc('increment_resource_downloads', { resource_id: resource.id });\r\n\r\n        return { success: true, message: 'Download recorded', download: data };\r\n    } catch (error) {\r\n        console.error('Add download error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Toggle saved item\r\nexport async function toggleSavedItem(itemId) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        // Check if already saved\r\n        const { data: existing } = await supabase\r\n            .from('saved_items')\r\n            .select('*')\r\n            .eq('profile_id', user.id)\r\n            .eq('item_id', itemId)\r\n            .single();\r\n\r\n        if (existing) {\r\n            // Remove it\r\n            const { error } = await supabase\r\n                .from('saved_items')\r\n                .delete()\r\n                .eq('profile_id', user.id)\r\n                .eq('item_id', itemId);\r\n\r\n            if (error) throw error;\r\n            return { success: true, message: 'Item removed from saved', saved: false };\r\n        } else {\r\n            // Add it\r\n            const { error } = await supabase\r\n                .from('saved_items')\r\n                .insert([{ profile_id: user.id, item_id: itemId }]);\r\n\r\n            if (error) throw error;\r\n            return { success: true, message: 'Item saved', saved: true };\r\n        }\r\n    } catch (error) {\r\n        console.error('Toggle saved error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Get user statistics\r\nexport async function getUserStats() {\r\n    try {\r\n        const profile = await getCurrentUser();\r\n        if (!profile) return null;\r\n\r\n        const stats = {\r\n            // Buyer Stats\r\n            totalPurchases: profile.purchases.length,\r\n            totalSpent: profile.purchases.reduce((sum, p) => sum + (p.price || 0), 0),\r\n            totalDownloads: profile.downloads.length,\r\n            savedItemsCount: profile.savedItems.length,\r\n\r\n            // Seller Stats\r\n            totalListings: profile.listings.length,\r\n            activeListings: profile.listings.filter(l => l.status === 'active').length,\r\n            soldListings: profile.listings.filter(l => l.status === 'sold').length,\r\n            totalSales: profile.sales.length,\r\n            totalRevenue: profile.sales.reduce((sum, s) => sum + (s.price || 0), 0),\r\n            uploadedResourcesCount: profile.uploadedResources.length\r\n        };\r\n\r\n        return stats;\r\n    } catch (error) {\r\n        console.error('Get stats error:', error.message);\r\n        return null;\r\n    }\r\n}\r\n\r\n","\n        import { getCurrentUser } from './auth.js?v=nuclear-v1';\n        async function checkAuth() {\n            try {\n                const user = await getCurrentUser();\n                if (user) {\n                    window.location.replace('market.html');\n                } else {\n                    document.body.style.display = 'block';\n                }\n            } catch (e) {\n                console.error(\"Auth check failed\", e);\n                document.body.style.display = 'block';\n            }\n        }\n        checkAuth();\n    ","// Supabase Configuration\r\n// This file will be populated once you have your Supabase credentials\r\n\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\n// TODO: Replace these with your actual Supabase project credentials\r\n// Get these from: https://app.supabase.com/project/_/settings/api\r\nconst supabaseUrl = 'https://dkswceahtpiiqnhfuytm.supabase.co'\r\nconst supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrc3djZWFodHBpaXFuaGZ1eXRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MTY1NTcsImV4cCI6MjA4MzM5MjU1N30.j5V6wx9KfFJb7R_KoaD-iOFvIC9kYZ4JC-vp3uMccj4'\r\n\r\n// Create Supabase client\r\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\r\n\r\n// Helper function to check if Supabase is configured\r\nexport function isSupabaseConfigured() {\r\n    return supabaseUrl !== 'YOUR_SUPABASE_URL' && supabaseAnonKey !== 'YOUR_SUPABASE_ANON_KEY'\r\n}\r\n\r\n// Export for debugging\r\nif (!isSupabaseConfigured()) {\r\n    console.warn('⚠️ Supabase is not configured yet. Please update supabase-config.js with your credentials.')\r\n}\r\n","// ===== SUPABASE AUTHENTICATION SYSTEM =====\r\nimport { supabase } from './supabase-config.js'\r\n\r\n// Register new user\r\n// Register new user\r\nexport async function registerUser(email, password, userData) {\r\n    try {\r\n        const { firstName, lastName, username, phone, role } = userData;\r\n        // 1. Sign up user with Supabase Auth including metadata\r\n        const { data: authData, error: authError } = await supabase.auth.signUp({\r\n            email,\r\n            password,\r\n            options: {\r\n                data: {\r\n                    first_name: firstName,\r\n                    last_name: lastName,\r\n                    username: username,\r\n                    phone: phone,\r\n                    username: username,\r\n                    phone: phone,\r\n                    role: role || 'user'\r\n                }\r\n            }\r\n        });\r\n\r\n        if (authError) throw authError;\r\n\r\n        // If email confirmation is disabled, we get a session immediately\r\n        if (authData.session) {\r\n            return { success: true, message: 'Registration successful!', user: authData.user };\r\n        }\r\n\r\n        // Return success for email verification flow\r\n        return { success: true, message: 'Registration successful! Please check your email for verification.', user: authData.user };\r\n\r\n    } catch (error) {\r\n        console.error('Registration error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Login user\r\nexport async function loginUser(email, password) {\r\n    try {\r\n        const { data, error } = await supabase.auth.signInWithPassword({\r\n            email,\r\n            password,\r\n        });\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'Login successful', user: data.user };\r\n    } catch (error) {\r\n        console.error('Login error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Logout user\r\nexport async function logoutUser() {\r\n    try {\r\n        const { error } = await supabase.auth.signOut();\r\n        if (error) throw error;\r\n\r\n        // Clear any remaining local storage session items if needed\r\n        localStorage.removeItem('marketplace_session');\r\n\r\n        return { success: true, message: 'Logged out successfully' };\r\n    } catch (error) {\r\n        console.error('Logout error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Get current session\r\nexport async function getCurrentSession() {\r\n    const { data: { session }, error } = await supabase.auth.getSession();\r\n    if (error) {\r\n        console.error('Session error:', error.message);\r\n        return null;\r\n    }\r\n    return session;\r\n}\r\n\r\n// Check if user is logged in\r\nexport async function isLoggedIn() {\r\n    const session = await getCurrentSession();\r\n    return !!session;\r\n}\r\nexport const checkAuthStatus = isLoggedIn;\r\n\r\n// Get current user profile data\r\n// Get current user profile data\r\nexport async function getCurrentUser() {\r\n    try {\r\n        console.log(\"APP_DEBUG: getCurrentUser called\");\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) return null;\r\n\r\n        // Fetch additional profile data from profiles table\r\n        // Use maybeSingle() to avoid 406 error if profile doesn't exist yet\r\n        const { data: profile, error: profileError } = await supabase\r\n            .from('profiles')\r\n            .select('*, role')\r\n            .eq('id', user.id)\r\n            .maybeSingle();\r\n\r\n        let userProfile = { ...user };\r\n\r\n        if (profileError) {\r\n            console.warn('Error fetching profile:', profileError.message);\r\n            // Return auth user with default role if profile fetch fails\r\n            userProfile = { ...user, role: 'user' };\r\n        } else if (!profile) {\r\n            console.warn('Profile missing for user, using default');\r\n            userProfile = { ...user, role: 'user' };\r\n        } else {\r\n            userProfile = { ...user, ...profile };\r\n        }\r\n\r\n        // Fetch activity data with relational joins\r\n        // Initialize activity data with empty defaults\r\n        let purchases = [], listings = [], sellerListingsForSales = [], downloads = [], savedItems = [], uploadedResources = [];\r\n\r\n        try {\r\n            const results = await Promise.all([\r\n                supabase.from('purchases').select('*').eq('buyer_id', user.id).order('purchase_date', { ascending: false }).then(r => r.data || []),\r\n                supabase.from('market_listings').select('*').eq('seller_id', user.id).order('created_at', { ascending: false }).then(r => r.data || []),\r\n                supabase.from('market_listings').select('id').eq('seller_id', user.id).then(r => r.data || []),\r\n                supabase.from('downloads').select('*, resource:free_resources(*)').eq('user_id', user.id).order('download_date', { ascending: false }).then(r => r.data || []),\r\n                supabase.from('saved_items').select('*').eq('profile_id', user.id).then(r => r.data || []),\r\n                supabase.from('free_resources').select('*').eq('uploader_id', user.id).order('created_at', { ascending: false }).then(r => r.data || [])\r\n            ]);\r\n            [purchases, listings, sellerListingsForSales, downloads, savedItems, uploadedResources] = results;\r\n        } catch (e) {\r\n            console.warn('Error fetching supplementary activity data:', e.message);\r\n        }\r\n\r\n        // Post-process sales\r\n        let sales = [];\r\n        try {\r\n            if (sellerListingsForSales && sellerListingsForSales.length > 0) {\r\n                const myItemIds = sellerListingsForSales.map(l => l.id);\r\n                const { data: salesData } = await supabase\r\n                    .from('purchases')\r\n                    .select('*')\r\n                    .in('item_id', myItemIds);\r\n                sales = salesData || [];\r\n            }\r\n        } catch (e) {\r\n            console.warn('Could not fetch sales data:', e.message);\r\n        }\r\n\r\n        return {\r\n            ...userProfile,\r\n            id: user.id,\r\n            first_name: userProfile.first_name || user.user_metadata?.first_name || '',\r\n            last_name: userProfile.last_name || user.user_metadata?.last_name || '',\r\n            username: userProfile.username || user.user_metadata?.username || user.user_metadata?.name || 'User',\r\n            email: userProfile.email || user.email || '',\r\n            phone: userProfile.phone || user.user_metadata?.phone || '',\r\n            role: userProfile.role || 'user',\r\n            immutable_user_code: userProfile.immutable_user_code || null,\r\n            purchases: purchases,\r\n            listings: listings,\r\n            sales: sales,\r\n            downloads: downloads,\r\n            savedItems: savedItems,\r\n            uploadedResources: uploadedResources\r\n        };\r\n    } catch (error) {\r\n        console.error('Get user error:', error.message);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Update user profile\r\nexport async function updateUser(updates) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .update(updates)\r\n            .eq('id', user.id)\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'User updated', user: data };\r\n    } catch (error) {\r\n        console.error('Update user error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Add purchase to user\r\nexport async function addPurchase(item) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('purchases')\r\n            .insert([\r\n                {\r\n                    buyer_id: user.id,\r\n                    item_id: item.id,\r\n                    item_title: item.title,\r\n                    price: item.price,\r\n                    category: item.category\r\n                }\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'Purchase recorded', purchase: data };\r\n    } catch (error) {\r\n        console.error('Add purchase error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Add listing to seller\r\nexport async function addListing(item) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('market_listings')\r\n            .insert([\r\n                {\r\n                    ...item,\r\n                    seller_id: user.id, // Absolute identity linking\r\n                    status: 'active'\r\n                }\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, message: 'Listing added', listing: data };\r\n    } catch (error) {\r\n        console.error('Add listing error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Add download to user\r\nexport async function addDownload(resource) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        const { data, error } = await supabase\r\n            .from('downloads')\r\n            .insert([\r\n                {\r\n                    user_id: user.id,\r\n                    resource_id: resource.id\r\n                }\r\n            ])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n\r\n        // Increment download count on the resource\r\n        await supabase.rpc('increment_resource_downloads', { resource_id: resource.id });\r\n\r\n        return { success: true, message: 'Download recorded', download: data };\r\n    } catch (error) {\r\n        console.error('Add download error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Toggle saved item\r\nexport async function toggleSavedItem(itemId) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('Not logged in');\r\n\r\n        // Check if already saved\r\n        const { data: existing } = await supabase\r\n            .from('saved_items')\r\n            .select('*')\r\n            .eq('profile_id', user.id)\r\n            .eq('item_id', itemId)\r\n            .single();\r\n\r\n        if (existing) {\r\n            // Remove it\r\n            const { error } = await supabase\r\n                .from('saved_items')\r\n                .delete()\r\n                .eq('profile_id', user.id)\r\n                .eq('item_id', itemId);\r\n\r\n            if (error) throw error;\r\n            return { success: true, message: 'Item removed from saved', saved: false };\r\n        } else {\r\n            // Add it\r\n            const { error } = await supabase\r\n                .from('saved_items')\r\n                .insert([{ profile_id: user.id, item_id: itemId }]);\r\n\r\n            if (error) throw error;\r\n            return { success: true, message: 'Item saved', saved: true };\r\n        }\r\n    } catch (error) {\r\n        console.error('Toggle saved error:', error.message);\r\n        return { success: false, message: error.message };\r\n    }\r\n}\r\n\r\n// Get user statistics\r\nexport async function getUserStats() {\r\n    try {\r\n        const profile = await getCurrentUser();\r\n        if (!profile) return null;\r\n\r\n        const stats = {\r\n            // Buyer Stats\r\n            totalPurchases: profile.purchases.length,\r\n            totalSpent: profile.purchases.reduce((sum, p) => sum + (p.price || 0), 0),\r\n            totalDownloads: profile.downloads.length,\r\n            savedItemsCount: profile.savedItems.length,\r\n\r\n            // Seller Stats\r\n            totalListings: profile.listings.length,\r\n            activeListings: profile.listings.filter(l => l.status === 'active').length,\r\n            soldListings: profile.listings.filter(l => l.status === 'sold').length,\r\n            totalSales: profile.sales.length,\r\n            totalRevenue: profile.sales.reduce((sum, s) => sum + (s.price || 0), 0),\r\n            uploadedResourcesCount: profile.uploadedResources.length\r\n        };\r\n\r\n        return stats;\r\n    } catch (error) {\r\n        console.error('Get stats error:', error.message);\r\n        return null;\r\n    }\r\n}\r\n\r\n","import { isLoggedIn, logoutUser, getCurrentUser } from './auth.js';\r\n\r\nexport async function initNavigation() {\r\n    setupMobileMenu();\r\n    await renderDesktopNav();\r\n}\r\n\r\nexport function setupMobileMenu() {\r\n    const menuToggle = document.querySelector('.menu-toggle');\r\n    const navLinks = document.querySelector('.nav-links'); // Keeping legacy mobile class for now\r\n\r\n    if (menuToggle && navLinks) {\r\n        // Simple override to ensure it toggles\r\n        menuToggle.onclick = () => {\r\n            navLinks.classList.toggle('active');\r\n            menuToggle.textContent = navLinks.classList.contains('active') ? '✕' : '☰';\r\n        };\r\n    }\r\n}\r\n\r\nasync function renderDesktopNav() {\r\n    const navContent = document.querySelector('.nav-content');\r\n    if (!navContent) return;\r\n\r\n    const user = await getCurrentUser();\r\n    const isAuth = !!user;\r\n\r\n    // SVG Icons\r\n    const gridIcon = `<svg class=\"menu-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\"></line><line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\"></line><line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\"></line></svg>`;\r\n    const userIcon = `<svg class=\"menu-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"><path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path><circle cx=\"12\" cy=\"7\" r=\"4\"></circle></svg>`;\r\n    const chevronDown = `<svg class=\"menu-icon\" style=\"width:14px; height:14px;\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"><polyline points=\"6 9 12 15 18 9\"></polyline></svg>`;\r\n\r\n    // Determine base URL for categories\r\n    const basePage = isAuth ? 'market.html' : 'index.html';\r\n\r\n    // Browse Dropdown HTML\r\n    const browseHtml = `\r\n        <div class=\"dropdown-container\" id=\"browseDropdown\">\r\n            <button class=\"icon-btn\" aria-expanded=\"false\" aria-haspopup=\"true\" aria-label=\"Browse Categories\">\r\n                ${gridIcon}\r\n            </button>\r\n            <div class=\"dropdown-menu-modern\" role=\"menu\" style=\"display: none;\">\r\n                <div class=\"dropdown-header\">Marketplace</div>\r\n                <a href=\"${basePage}?category=all\" class=\"menu-item\" role=\"menuitem\">\r\n                    All Listings\r\n                </a>\r\n                <a href=\"${basePage}?type=free\" class=\"menu-item\" role=\"menuitem\">\r\n                    Free Resources\r\n                </a>\r\n                <a href=\"skills-hub.html\" class=\"menu-item\" role=\"menuitem\">\r\n                    Skills Hub\r\n                </a>\r\n                <div class=\"dropdown-divider\"></div>\r\n                <div class=\"dropdown-header\">Categories</div>\r\n                <a href=\"${basePage}?category=electronics\" class=\"menu-item\" role=\"menuitem\">Electronics</a>\r\n                <a href=\"${basePage}?category=books\" class=\"menu-item\" role=\"menuitem\">Books</a>\r\n                <a href=\"${basePage}?category=furniture\" class=\"menu-item\" role=\"menuitem\">Furniture</a>\r\n                <a href=\"${basePage}?category=services\" class=\"menu-item\" role=\"menuitem\">Services</a>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    // Right-side Navigation HTML (Conditional)\r\n    let rightNavHtml = '';\r\n    if (isAuth) {\r\n        const isSeller = user.role === 'seller';\r\n\r\n        // Build Navigation based on Role\r\n        let linksHtml = '';\r\n\r\n        if (isSeller) {\r\n            linksHtml = `\r\n                 <a href=\"#\" id=\"navPostItem\" class=\"nav-link\">Post Item</a>\r\n                 <a href=\"admin.html\" class=\"nav-link\">Dashboard</a>\r\n                 <a href=\"skills-hub.html\" class=\"nav-link\">Skills Hub</a>\r\n                 <a href=\"messages.html\" class=\"nav-link\">Messages</a>\r\n            `;\r\n        } else {\r\n            // Buyer / Student View\r\n            linksHtml = `\r\n                 <a href=\"market.html\" class=\"nav-link\">Browse Marketplace</a>\r\n                 <a href=\"become-seller.html\" class=\"nav-link\">Become a Seller</a>\r\n                 <a href=\"skills-hub.html\" class=\"nav-link\">Learn</a>\r\n                 <a href=\"messages.html\" class=\"nav-link\">Messages</a>\r\n            `;\r\n        }\r\n\r\n        // Logged in: Show requested links\r\n        rightNavHtml = `\r\n            <div class=\"nav-links\">\r\n                 ${linksHtml}\r\n            </div>\r\n            <div class=\"dropdown-container\" id=\"profileDropdown\" style=\"margin-left: 8px;\">\r\n                 <button class=\"icon-btn\" aria-expanded=\"false\" aria-haspopup=\"true\" aria-label=\"User Menu\">\r\n                    ${userIcon}\r\n                </button>\r\n                <div class=\"dropdown-menu-modern\" role=\"menu\" style=\"display: none;\">\r\n                    <div class=\"dropdown-header\">Signed in as <br><span style=\"color:var(--text-primary);\">${user.name || user.username || 'User'}</span></div>\r\n                    <div class=\"dropdown-divider\"></div>\r\n                    ${isSeller ? '<a href=\"admin.html\" class=\"menu-item\" role=\"menuitem\">Seller Dashboard</a>' : ''}\r\n                    <a href=\"account.html\" class=\"menu-item\" role=\"menuitem\">Account Settings</a>\r\n                    <button id=\"menuLogout\" class=\"menu-item danger\" role=\"menuitem\">Log out</button>\r\n                </div>\r\n            </div>\r\n        `;\r\n    } else {\r\n        // Logged out: Show Sign up and Log in buttons\r\n        rightNavHtml = `\r\n             <div class=\"nav-links\">\r\n                 <button class=\"btn-primary\" id=\"navSignupBtn\">Sign up</button>\r\n                 <button class=\"nav-link\" id=\"navLoginBtn\" style=\"border:none; background:none; cursor:pointer;\">Log in</button>\r\n             </div>\r\n        `;\r\n    }\r\n\r\n    // Logo HTML\r\n    const logoHtml = `\r\n        <a href=\"index.html\" class=\"logo\" style=\"flex-direction: row; gap: 10px; align-items: center;\">\r\n            <svg width=\"32\" height=\"32\" viewBox=\"0 0 32 32\" fill=\"none\">\r\n                <rect width=\"32\" height=\"32\" rx=\"8\" fill=\"url(#gradient1)\" />\r\n                <path d=\"M16 8L22 14L16 20L10 14L16 20L16 8Z\" fill=\"white\" />\r\n                <defs>\r\n                    <linearGradient id=\"gradient1\" x1=\"0\" y1=\"0\" x2=\"32\" y2=\"32\">\r\n                        <stop offset=\"0%\" stop-color=\"#368CBF\" />\r\n                        <stop offset=\"100%\" stop-color=\"#E6DBC9\" />\r\n                    </linearGradient>\r\n                </defs>\r\n            </svg>\r\n            <span class=\"logo-text\" style=\"font-size: 1.1rem; margin-top: 0;\">Campus Market</span>\r\n        </a>\r\n    `;\r\n\r\n    // Nav Search HTML\r\n    const navSearchHtml = `\r\n        <div class=\"nav-search-wrapper\">\r\n             <div class=\"nav-search-bar\">\r\n                <svg class=\"search-icon\" width=\"18\" height=\"18\" viewBox=\"0 0 20 20\" fill=\"none\">\r\n                    <circle cx=\"9\" cy=\"9\" r=\"6\" stroke=\"currentColor\" stroke-width=\"2\" />\r\n                    <path d=\"M14 14L18 18\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" />\r\n                </svg>\r\n                <input type=\"text\" id=\"navSearchInput\" placeholder=\"Search marketplace...\">\r\n             </div>\r\n        </div>\r\n    `;\r\n\r\n    // Layout Assembly\r\n    // Only show mobile toggle if we have links to toggle (i.e. if logged in)\r\n    const mobileToggleHtml = isAuth ? `<button class=\"menu-toggle\">☰</button>` : '';\r\n\r\n    navContent.innerHTML = `\r\n        <div class=\"nav-left\" style=\"display:flex; align-items:center;\">\r\n             ${logoHtml}\r\n             <div style=\"margin-left: 16px;\">${browseHtml}</div>\r\n        </div>\r\n        \r\n        <div class=\"nav-center\" style=\"flex: 1; display: flex; justify-content: center; padding: 0 20px;\">\r\n             ${navSearchHtml}\r\n        </div>\r\n        \r\n        <div class=\"nav-right\" style=\"display: flex; align-items: center; gap: 12px;\">\r\n             ${rightNavHtml}\r\n             ${mobileToggleHtml}\r\n        </div>\r\n    `;\r\n\r\n    attachEventListeners();\r\n}\r\n\r\nfunction attachEventListeners() {\r\n    // Dropdown Toggles\r\n    const dropdowns = document.querySelectorAll('.dropdown-container');\r\n\r\n    dropdowns.forEach(dropdown => {\r\n        const trigger = dropdown.querySelector('.icon-btn');\r\n        const menu = dropdown.querySelector('.dropdown-menu-modern');\r\n\r\n        if (!trigger || !menu) return;\r\n\r\n        trigger.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            const isOpen = dropdown.classList.contains('open');\r\n\r\n            // Close all others\r\n            closeAllDropdowns();\r\n\r\n            if (!isOpen) {\r\n                dropdown.classList.add('open');\r\n                trigger.setAttribute('aria-expanded', 'true');\r\n                trigger.classList.add('active');\r\n            }\r\n        });\r\n\r\n        // Keyboard support\r\n        trigger.addEventListener('keydown', (e) => {\r\n            if (e.key === 'Escape') {\r\n                closeAllDropdowns();\r\n                trigger.focus();\r\n            }\r\n        });\r\n    });\r\n\r\n    // Close on click outside\r\n    document.addEventListener('click', (e) => {\r\n        if (!e.target.closest('.dropdown-container')) {\r\n            closeAllDropdowns();\r\n        }\r\n    });\r\n\r\n    // Handle Actions\r\n    const logoutHandler = async () => {\r\n        await logoutUser();\r\n        window.location.href = 'index.html';\r\n    };\r\n\r\n    const logoutBtnMenu = document.getElementById('menuLogout');\r\n    if (logoutBtnMenu) logoutBtnMenu.addEventListener('click', logoutHandler);\r\n\r\n    const logoutBtnNav = document.getElementById('navLogout');\r\n    if (logoutBtnNav) logoutBtnNav.addEventListener('click', logoutHandler);\r\n\r\n\r\n    const postItemHandler = (e) => {\r\n        e.preventDefault();\r\n        const isHomePage = window.location.pathname.endsWith('index.html') || window.location.pathname.endsWith('/');\r\n\r\n        if (isHomePage) {\r\n            document.dispatchEvent(new CustomEvent('open-post-modal'));\r\n        } else {\r\n            window.location.href = 'index.html?action=post';\r\n        }\r\n    };\r\n\r\n    const postItemBtnMenu = document.getElementById('menuPostItem');\r\n    if (postItemBtnMenu) postItemBtnMenu.addEventListener('click', postItemHandler);\r\n\r\n    const postItemBtnNav = document.getElementById('navPostItem');\r\n    if (postItemBtnNav) postItemBtnNav.addEventListener('click', postItemHandler);\r\n\r\n    const loginBtn = document.getElementById('navLoginBtn');\r\n    if (loginBtn) {\r\n        loginBtn.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            const authModal = document.getElementById('authModal');\r\n            if (authModal) {\r\n                // Show login tab\r\n                document.querySelector('.auth-tab[data-tab=\"login\"]')?.click();\r\n                authModal.classList.add('active');\r\n            }\r\n        });\r\n    }\r\n\r\n    const signupBtn = document.getElementById('navSignupBtn');\r\n    if (signupBtn) {\r\n        signupBtn.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            const authModal = document.getElementById('authModal');\r\n            if (authModal) {\r\n                // Show register tab\r\n                document.querySelector('.auth-tab[data-tab=\"register\"]')?.click();\r\n                authModal.classList.add('active');\r\n            }\r\n        });\r\n    }\r\n\r\n    // Nav Search Listener\r\n    const navSearchInput = document.getElementById('navSearchInput');\r\n    if (navSearchInput) {\r\n        navSearchInput.addEventListener('keypress', (e) => {\r\n            if (e.key === 'Enter') {\r\n                const mainSearch = document.getElementById('marketplaceGrid'); // Checking if we are on index\r\n                if (!mainSearch) {\r\n                    window.location.href = `index.html?search=${encodeURIComponent(e.target.value)}`;\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction closeAllDropdowns() {\r\n    document.querySelectorAll('.dropdown-container').forEach(d => {\r\n        d.classList.remove('open');\r\n        const trigger = d.querySelector('.icon-btn');\r\n        if (trigger) {\r\n            trigger.setAttribute('aria-expanded', 'false');\r\n            trigger.classList.remove('active');\r\n        }\r\n    });\r\n}\r\n","import { supabase } from './supabase-config.js?v=fixed';\r\nimport { isLoggedIn } from './auth.js?v=fixed';\r\n\r\n/**\r\n * Fetches all active items from the marketplace.\r\n * Handles RLS policies: authenticated users get profile data, public users don't.\r\n */\r\nexport async function fetchAllItems() {\r\n    try {\r\n        // Check if user is authenticated\r\n        const isAuth = await isLoggedIn();\r\n\r\n        if (isAuth) {\r\n            // Authenticated: Try to fetch with profile join\r\n            console.log('Fetching items with profile data (authenticated)...');\r\n            const { data, error } = await supabase\r\n                .from('market_listings')\r\n                .select(`\r\n                    *,\r\n                    profiles (\r\n                        username,\r\n                        full_name,\r\n                        immutable_user_code\r\n                    )\r\n                `)\r\n                .eq('status', 'active')\r\n                .order('created_at', { ascending: false });\r\n\r\n            if (!error) {\r\n                console.log('Successfully fetched items with profiles:', data?.length);\r\n                return data || [];\r\n            }\r\n\r\n            console.warn('Profile join failed for authenticated user, using fallback:', error);\r\n        } else {\r\n            console.log('Fetching items without profile data (public user)...');\r\n        }\r\n\r\n        // Fallback for unauthenticated users OR if join fails\r\n        // This query will succeed even with restrictive RLS on profiles table\r\n        const { data: publicData, error: publicError } = await supabase\r\n            .from('market_listings')\r\n            .select('*')\r\n            .eq('status', 'active')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (publicError) {\r\n            console.error('Failed to fetch marketplace items:', publicError);\r\n            throw publicError;\r\n        }\r\n\r\n        console.log('Successfully fetched public items:', publicData?.length);\r\n        return publicData || [];\r\n\r\n    } catch (error) {\r\n        console.error('Critical items fetch error:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Renders an item card with conditional visibility based on authentication status.\r\n * Public users see privacy-protected cards, authenticated users see full details.\r\n */\r\nexport function createItemCard(item, isAuth = false) {\r\n    const postedDate = new Date(item.created_at).toLocaleDateString();\r\n\r\n    // Prioritize image_url, fallback to images array, then placeholder\r\n    let mainImage = item.image_url;\r\n    if (!mainImage && item.images && item.images.length > 0) {\r\n        mainImage = item.images[0];\r\n    }\r\n    if (!mainImage) {\r\n        mainImage = 'https://placehold.co/300x200?text=No+Image';\r\n    }\r\n\r\n    // SECURITY: Conditional seller information display\r\n    if (isAuth) {\r\n        // Authenticated users see full seller details\r\n        return createAuthenticatedCard(item, mainImage, postedDate);\r\n    } else {\r\n        // Public users see privacy-protected card\r\n        return createPublicCard(item, mainImage, postedDate);\r\n    }\r\n}\r\n\r\n/**\r\n * Creates a full-featured card for authenticated users\r\n */\r\nfunction createAuthenticatedCard(item, mainImage, postedDate) {\r\n    const sellerName = item.profiles?.username || item.profiles?.full_name || 'Anonymous';\r\n    const sellerId = item.profiles?.immutable_user_code || (item.seller_id ? item.seller_id.slice(0, 6).toUpperCase() : 'N/A');\r\n\r\n    return `\r\n        <div class=\"marketplace-item\" data-id=\"${item.id}\" data-user-id=\"${item.seller_id}\">\r\n            <div class=\"item-image\" style=\"background-image: url('${mainImage}');\"></div>\r\n            <div class=\"item-content\">\r\n                <h3 class=\"item-title\">${escapeHtml(item.title || 'Untitled Item')}</h3>\r\n                <div class=\"item-price\">R ${parseFloat(item.price || 0).toLocaleString()}</div>\r\n                \r\n                <div class=\"item-meta\" style=\"flex-direction: column; align-items: flex-start; gap: 2px;\">\r\n                    <div style=\"display: flex; align-items: center; gap: 0.5rem;\">\r\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path><circle cx=\"12\" cy=\"7\" r=\"4\"></circle></svg>\r\n                        <span style=\"font-weight: 700;\">${escapeHtml(sellerName)}</span>\r\n                    </div>\r\n                    <span style=\"font-size: 0.75rem; color: var(--text-muted); padding-left: 1.4rem;\">Posted by User ID: ${sellerId}</span>\r\n                </div>\r\n                \r\n                <div class=\"item-date\">\r\n                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><rect x=\"3\" y=\"4\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect><line x1=\"16\" y1=\"2\" x2=\"16\" y2=\"6\"></line><line x1=\"8\" y1=\"2\" x2=\"8\" y2=\"6\"></line><line x1=\"3\" y1=\"10\" x2=\"21\" y2=\"10\"></line></svg>\r\n                    <span>Posted on ${postedDate}</span>\r\n                </div>\r\n                <div class=\"item-directions\">\r\n                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><path d=\"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z\"></path><circle cx=\"12\" cy=\"10\" r=\"3\"></circle></svg>\r\n                    <span>Directions Available</span>\r\n                </div>\r\n                \r\n                <div class=\"item-actions\" style=\"margin-top: auto; display: flex; gap: 0.5rem;\">\r\n                    <button class=\"btn-view-item\" data-action=\"view\" data-id=\"${item.id}\" style=\"flex:1;\">View Info</button>\r\n                    <button class=\"btn-view-item contact-seller-btn\" \r\n                            data-seller-id=\"${item.seller_id}\" \r\n                            data-listing-id=\"${item.id}\"\r\n                            style=\"flex:1; background:transparent; color:var(--primary-color); border-color:var(--primary-color);\">\r\n                        Contact\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n/**\r\n * Creates a privacy-protected card for public (unauthenticated) users\r\n */\r\nfunction createPublicCard(item, mainImage, postedDate) {\r\n    return `\r\n        <div class=\"marketplace-item public-view\" data-id=\"${item.id}\">\r\n            <div class=\"item-image\" style=\"background-image: url('${mainImage}');\"></div>\r\n            <div class=\"item-content\">\r\n                <h3 class=\"item-title\">${escapeHtml(item.title || 'Untitled Item')}</h3>\r\n                <div class=\"item-price\">R ${parseFloat(item.price || 0).toLocaleString()}</div>\r\n                \r\n                <div class=\"item-meta\" style=\"flex-direction: column; align-items: flex-start; gap: 2px;\">\r\n                    <div style=\"display: flex; align-items: center; gap: 0.5rem;\">\r\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"></path><circle cx=\"12\" cy=\"7\" r=\"4\"></circle></svg>\r\n                        <span style=\"font-weight: 700; color: var(--text-muted);\">\r\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"display: inline; margin-right: 4px;\">\r\n                                <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\"></rect>\r\n                                <path d=\"M7 11V7a5 5 0 0 1 10 0v4\"></path>\r\n                            </svg>\r\n                            Registered User\r\n                        </span>\r\n                    </div>\r\n                    <span style=\"font-size: 0.75rem; color: var(--text-muted); padding-left: 1.4rem;\">\r\n                        <a href=\"#\" onclick=\"event.preventDefault(); document.getElementById('authModal')?.classList.add('active');\" style=\"color: var(--primary-color); text-decoration: underline;\">\r\n                            Login to view seller\r\n                        </a>\r\n                    </span>\r\n                </div>\r\n                \r\n                <div class=\"item-date\">\r\n                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><rect x=\"3\" y=\"4\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect><line x1=\"16\" y1=\"2\" x2=\"16\" y2=\"6\"></line><line x1=\"8\" y1=\"2\" x2=\"8\" y2=\"6\"></line><line x1=\"3\" y1=\"10\" x2=\"21\" y2=\"10\"></line></svg>\r\n                    <span>Posted on ${postedDate}</span>\r\n                </div>\r\n                <div class=\"item-directions\">\r\n                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><path d=\"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z\"></path><circle cx=\"12\" cy=\"10\" r=\"3\"></circle></svg>\r\n                    <span>Category: ${escapeHtml(item.category || 'General')}</span>\r\n                </div>\r\n                \r\n                <div class=\"item-actions\" style=\"margin-top: auto; display: flex; gap: 0.5rem;\">\r\n                    <button class=\"btn-view-item\" data-action=\"view\" data-id=\"${item.id}\" style=\"flex:1;\">View Details</button>\r\n                    <button class=\"btn-view-item\" \r\n                            onclick=\"event.preventDefault(); document.getElementById('authModal')?.classList.add('active'); document.querySelector('.auth-tab[data-tab=\\\\'login\\\\']')?.click();\"\r\n                            style=\"flex:1; background:transparent; color:var(--primary-color); border-color:var(--primary-color); position: relative;\">\r\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"display: inline; margin-right: 4px;\">\r\n                            <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\"></rect>\r\n                            <path d=\"M7 11V7a5 5 0 0 1 10 0v4\"></path>\r\n                        </svg>\r\n                        Login to Contact\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n// Helper to escape HTML to prevent XSS\r\nfunction escapeHtml(text) {\r\n    if (!text) return '';\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n}\r\n","import { supabase } from './supabase-config.js';\r\nimport { getCurrentUser, isLoggedIn } from './auth.js';\r\n\r\n/**\r\n * Saves or unsaves an item for the authenticated user.\r\n * Implements \"Prevent duplicate saves\" logic.\r\n */\r\nexport async function toggleSaveItem(itemId) {\r\n    if (!await isLoggedIn()) {\r\n        alert(\"Please log in to save items.\");\r\n        document.dispatchEvent(new CustomEvent('open-auth-modal'));\r\n        return;\r\n    }\r\n\r\n    const user = await getCurrentUser();\r\n    if (!user) return;\r\n\r\n    try {\r\n        // 1. Check if already saved (Duplicate prevention)\r\n        const { data: existing, error: fetchError } = await supabase\r\n            .from('saved_items')\r\n            .select('id')\r\n            .eq('user_id', user.id)\r\n            .eq('item_id', itemId)\r\n            .maybeSingle();\r\n\r\n        if (fetchError) throw fetchError;\r\n\r\n        if (existing) {\r\n            // 2. Unsave if already exists\r\n            const { error: deleteError } = await supabase\r\n                .from('saved_items')\r\n                .delete()\r\n                .eq('id', existing.id);\r\n\r\n            if (deleteError) throw deleteError;\r\n            return { saved: false, message: 'Item removed from bookmarks' };\r\n        } else {\r\n            // 3. Save if doesn't exist\r\n            const { error: insertError } = await supabase\r\n                .from('saved_items')\r\n                .insert([{ user_id: user.id, item_id: itemId }]);\r\n\r\n            if (insertError) throw insertError;\r\n            return { saved: true, message: 'Item saved successfully!' };\r\n        }\r\n    } catch (error) {\r\n        console.error('Save error:', error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Setup listeners for save buttons globally\r\n */\r\nexport function initSaveListeners() {\r\n    document.addEventListener('click', async (e) => {\r\n        if (e.target.classList.contains('btn-save')) {\r\n            const itemId = e.target.dataset.itemId;\r\n            const btn = e.target;\r\n\r\n            btn.disabled = true;\r\n            try {\r\n                const result = await toggleSaveItem(itemId);\r\n                btn.classList.toggle('active', result.saved);\r\n                btn.textContent = result.saved ? 'Saved' : 'Save';\r\n                // Feedback could be a toast or simple alert\r\n                console.log(result.message);\r\n            } catch (err) {\r\n                alert(\"Failed to save item.\");\r\n            } finally {\r\n                btn.disabled = false;\r\n            }\r\n        }\r\n    });\r\n}\r\n","// ===== SUPABASE INTEGRATION =====\r\nconsole.log(\"APP_DEBUG: main.js LOADED - NUCLEAR VERSION V1 [TIMESTAMP: \" + new Date().toISOString() + \"]\");\r\nimport { supabase } from './supabase-config.js?v=fixed';\r\nimport {\r\n    registerUser,\r\n    loginUser,\r\n    logoutUser,\r\n    getCurrentSession,\r\n    isLoggedIn,\r\n    getCurrentUser,\r\n    addListing,\r\n    addDownload,\r\n    checkAuthStatus\r\n} from './auth.js?v=fixed';\r\nimport { initNavigation } from './navbar.js?v=fixed';\r\n// Removed invalid import\r\nimport { fetchAllItems, createItemCard } from './items.js?v=fixed';\r\nimport { initSaveListeners } from './save-item.js?v=fixed';\r\n\r\n// ===== STATE MANAGEMENT =====\r\nlet currentCategory = 'all';\r\nlet currentResourceType = 'all';\r\nlet marketplaceItems = [];\r\nlet resources = [];\r\n\r\n// ===== DOM ELEMENTS =====\r\nconst uploadModal = document.getElementById('uploadModal');\r\nconst resourceModal = document.getElementById('resourceModal');\r\nconst authModal = document.getElementById('authModal');\r\nconst postItemBtn = document.getElementById('postItemBtn');\r\nconst uploadResourceBtn = document.getElementById('uploadResourceBtn');\r\n// const closeModalBtn = document.getElementById('closeModal'); // Handled by navbar/generic logic if present\r\n// const closeResourceModalBtn = document.getElementById('closeResourceModal');\r\n// const closeAuthModalBtn = document.getElementById('closeAuthModal');\r\nconst uploadForm = document.getElementById('uploadForm');\r\nconst resourceForm = document.getElementById('resourceForm');\r\nconst loginForm = document.getElementById('loginForm');\r\nconst registerForm = document.getElementById('registerForm');\r\nconst searchInput = document.getElementById('searchInput');\r\nconst marketplaceGrid = document.getElementById('marketplaceGrid');\r\nconst resourcesGrid = document.getElementById('resourcesGrid');\r\nconst loginBtn = document.getElementById('loginBtn');\r\n// const logoutBtn = document.getElementById('logoutBtn');\r\n// const userMenu = document.getElementById('userMenu');\r\nconst dashboardLink = document.getElementById('dashboardLink');\r\n\r\n// ===== INITIALIZATION =====\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n    await initNavigation();\r\n\r\n    // Check auth status to update UI\r\n    await updateAuthUI();\r\n    console.log(\"APP_DEBUG: Script.js loaded.\");\r\n\r\n    // Homepage Guard REMOVED - Handled by inline script in index.html to prevent flash\r\n\r\n\r\n    // Initial content load\r\n    // Initial content load - ONLY if on a page with the grid\r\n    if (document.getElementById('marketplaceGrid')) {\r\n        refreshMarketplace();\r\n    }\r\n    if (document.getElementById('resourcesGrid')) {\r\n        fetchResources();\r\n    }\r\n    initSaveListeners();\r\n\r\n    // Check URL parameters for actions (e.g., immediate post triggering)\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    if (urlParams.get('action') === 'post') {\r\n        setTimeout(() => {\r\n            document.dispatchEvent(new CustomEvent('open-post-modal'));\r\n        }, 800);\r\n    }\r\n\r\n    setupEventListeners();\r\n\r\n    // Global Auth Logic: Handle redirects on state change (Logout)\r\n    supabase.auth.onAuthStateChange(async (event, session) => {\r\n        if (event === 'SIGNED_OUT') {\r\n            window.location.href = 'index.html';\r\n        } else if (event === 'SIGNED_IN') {\r\n            const user = await getCurrentUser();\r\n            const currentPath = window.location.pathname;\r\n\r\n            // Redirect logic for Homepage / Index\r\n            if (currentPath.endsWith('index.html') || currentPath.endsWith('/') || currentPath === '/') {\r\n                // Unified Redirect: Everyone goes to market.html\r\n                window.location.href = 'market.html';\r\n            }\r\n        }\r\n    });\r\n});\r\n\r\nasync function updateAuthUI() {\r\n    const user = await getCurrentUser();\r\n\r\n    // Landing page sections to toggle\r\n    const heroSection = document.querySelector('.landing-hero');\r\n    const trustSection = document.querySelector('.trust-section');\r\n    const howItWorksSection = document.querySelector('.how-it-works');\r\n    const heroAuthCtas = document.getElementById('heroAuthCtas');\r\n\r\n    if (user) {\r\n        // Hide marketing fluff for logged-in users\r\n        if (heroSection) heroSection.style.display = 'none';\r\n        if (trustSection) trustSection.style.display = 'none';\r\n        if (howItWorksSection) howItWorksSection.style.display = 'none';\r\n        if (heroAuthCtas) heroAuthCtas.style.display = 'none';\r\n    } else {\r\n        // Show for guests\r\n        if (heroSection) heroSection.style.display = 'block';\r\n        if (trustSection) trustSection.style.display = 'block';\r\n        if (howItWorksSection) howItWorksSection.style.display = 'block';\r\n        if (heroAuthCtas) heroAuthCtas.style.display = 'flex';\r\n        setupHeroListeners();\r\n    }\r\n}\r\n\r\nfunction setupHeroListeners() {\r\n    const signupBtn = document.getElementById('heroSignupBtn');\r\n    const loginBtn = document.getElementById('heroLoginBtn');\r\n    const authModal = document.getElementById('authModal');\r\n\r\n    if (signupBtn && authModal) {\r\n        signupBtn.onclick = () => {\r\n            document.querySelector('.auth-tab[data-tab=\"register\"]')?.click();\r\n            authModal.classList.add('active');\r\n        };\r\n    }\r\n\r\n    if (loginBtn) {\r\n        loginBtn.onclick = () => {\r\n            // Scroll to marketplace\r\n            const marketplace = document.getElementById('marketplace');\r\n            if (marketplace) {\r\n                marketplace.scrollIntoView({ behavior: 'smooth' });\r\n            }\r\n        };\r\n    }\r\n}\r\n\r\nasync function refreshMarketplace() {\r\n    const isAuth = await isLoggedIn();\r\n    const items = await fetchAllItems();\r\n    if (marketplaceGrid) {\r\n        if (items && items.length > 0) {\r\n            marketplaceGrid.innerHTML = items.map(item => createItemCard(item, isAuth)).join('');\r\n        } else {\r\n            marketplaceGrid.innerHTML = '<p class=\"empty-state\">No items found. Be the first to post!</p>';\r\n        }\r\n    }\r\n}\r\n\r\n// Global listener for re-rendering when an item is posted\r\ndocument.addEventListener('item-posted', refreshMarketplace);\r\n\r\n// ===== DATA FETCHING (Resources) =====\r\nasync function fetchResources() {\r\n    if (!resourcesGrid) return; // Guard clause\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('free_resources')\r\n            .select('*')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n        resources = data || [];\r\n        renderResources();\r\n    } catch (error) {\r\n        console.error('Error fetching resources:', error.message);\r\n        resourcesGrid.innerHTML = '<p class=\"error-state\">Failed to load resources.</p>';\r\n    }\r\n}\r\n\r\nfunction renderResources() {\r\n    if (!resourcesGrid) return;\r\n\r\n    const filteredResources = resources.filter(resource => {\r\n        if (currentResourceType === 'all') return true;\r\n        return resource.type === currentResourceType;\r\n    });\r\n\r\n    if (filteredResources.length === 0) {\r\n        resourcesGrid.innerHTML = '<p class=\"empty-state\">No resources found.</p>';\r\n        return;\r\n    }\r\n\r\n    resourcesGrid.innerHTML = filteredResources.map(resource => createResourceCard(resource)).join('');\r\n}\r\n\r\nfunction createResourceCard(resource) {\r\n    const icons = {\r\n        exam: `<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\"><path d=\"M9 12L11 14L15 10\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><rect x=\"4\" y=\"4\" width=\"16\" height=\"16\" rx=\"2\" stroke=\"currentColor\" stroke-width=\"2\"/></svg>`,\r\n        textbook: `<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\"><path d=\"M4 19.5A2.5 2.5 0 0 1 6.5 17H20\" stroke=\"currentColor\" stroke-width=\"2\"/><path d=\"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\" stroke=\"currentColor\" stroke-width=\"2\"/></svg>`,\r\n        notes: `<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\"><path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\" stroke=\"currentColor\" stroke-width=\"2\"/><path d=\"M14 2v6h6M16 13H8M16 17H8M10 9H8\" stroke=\"currentColor\" stroke-width=\"2\"/></svg>`\r\n    };\r\n\r\n    return `\r\n        <div class=\"resource-card\" data-id=\"${resource.id}\">\r\n            <div class=\"resource-header\">\r\n                <div class=\"resource-icon\">\r\n                    ${icons[resource.type] || icons.exam}\r\n                </div>\r\n                <div class=\"resource-info\">\r\n                    <span class=\"resource-type\">${resource.type}</span>\r\n                    <h3 class=\"resource-title\">${resource.title}</h3>\r\n                    <p class=\"resource-course\">${resource.course}</p>\r\n                </div>\r\n            </div>\r\n            <div class=\"resource-meta\">\r\n                <span class=\"resource-year\">${resource.year}</span>\r\n                <button class=\"download-btn\">\r\n                    <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\">\r\n                        <path d=\"M8 11V3M8 11L5 8M8 11L11 8\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n                        <path d=\"M2 13H14\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/>\r\n                    </svg>\r\n                    Download\r\n                </button>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\n// ===== EVENT LISTENERS =====\r\nfunction setupEventListeners() {\r\n    // Search functionality (Dynamic check for Nav Search)\r\n    const activeSearchInput = document.getElementById('navSearchInput') || document.getElementById('searchInput');\r\n\r\n    // ===== SEARCH & FILTERS =====\r\n    if (activeSearchInput) {\r\n        activeSearchInput.addEventListener('input', debounce(handleSearch, 300));\r\n    }\r\n\r\n    // Category Filtering (Sidebar & Chips)\r\n    const categoryButtons = document.querySelectorAll('.category-chip, .sidebar-link[data-category]');\r\n\r\n    categoryButtons.forEach(button => {\r\n        button.addEventListener('click', () => {\r\n            // Remove active class from all buttons\r\n            categoryButtons.forEach(btn => btn.classList.remove('active'));\r\n            // Add active class to clicked button\r\n            button.classList.add('active');\r\n\r\n            // Update state and refresh\r\n            currentCategory = button.dataset.category;\r\n            refreshMarketplace();\r\n        });\r\n    });\r\n\r\n    // Resource Filtering\r\n    const resourceChips = document.querySelectorAll('.resource-chip');\r\n    resourceChips.forEach(chip => {\r\n        chip.addEventListener('click', () => {\r\n            resourceChips.forEach(c => c.classList.remove('active'));\r\n            chip.classList.add('active');\r\n\r\n            currentResourceType = chip.dataset.type;\r\n            renderResources();\r\n        });\r\n    });\r\n\r\n    // Forms - Handled by standalone pages or updated logic\r\n    // if (uploadForm) uploadForm.addEventListener('submit', handleItemPost);\r\n\r\n    // Auth Forms\r\n    if (loginForm) {\r\n        loginForm.addEventListener('submit', async (e) => {\r\n            e.preventDefault();\r\n            const email = document.getElementById('loginEmail').value;\r\n            const password = document.getElementById('loginPassword').value;\r\n            const result = await loginUser(email, password);\r\n            if (result.success) {\r\n                // Fetch user to check role\r\n                const user = await getCurrentUser();\r\n                if (user?.role === 'seller') {\r\n                    window.location.href = 'admin.html';\r\n                } else {\r\n                    window.location.href = 'market.html';\r\n                }\r\n            } else {\r\n                alert(result.message);\r\n            }\r\n        });\r\n    }\r\n\r\n    if (registerForm) {\r\n        registerForm.addEventListener('submit', async (e) => {\r\n            e.preventDefault();\r\n            const userData = {\r\n                firstName: document.getElementById('registerFirstName').value,\r\n                lastName: document.getElementById('registerLastName').value,\r\n                username: document.getElementById('registerUsername').value,\r\n                phone: document.getElementById('registerPhone').value,\r\n                role: document.getElementById('registerRole').value\r\n            };\r\n            const email = document.getElementById('registerEmail').value;\r\n            const password = document.getElementById('registerPassword').value;\r\n\r\n            const result = await registerUser(email, password, userData);\r\n            if (result.success) {\r\n                // Fetch user to check role, or rely on what we just sent\r\n                const user = await getCurrentUser(); // Better to fetch fresh state or rely on metadata if instant\r\n\r\n                // For new users, role comes from the form select or default\r\n                // But let's trust the profile/session\r\n                if (user?.role === 'seller') {\r\n                    window.location.href = 'admin.html';\r\n                } else {\r\n                    // Default for new buyers\r\n                    window.location.href = 'market.html';\r\n                }\r\n            } else {\r\n                alert(result.message);\r\n            }\r\n        });\r\n    }\r\n\r\n    if (resourceForm) {\r\n        resourceForm.addEventListener('submit', handleResourceUpload);\r\n    }\r\n\r\n    // DELEGATED EVENT LISTENERS (Fix for 'Dead Buttons')\r\n    // Marketplace Grid Actions\r\n    if (marketplaceGrid) {\r\n        marketplaceGrid.addEventListener('click', async (e) => {\r\n            const btn = e.target.closest('button');\r\n            if (!btn) return;\r\n\r\n            const action = btn.dataset.action;\r\n            const id = btn.dataset.id;\r\n\r\n            if (action === 'buy') {\r\n                window.location.href = `payment.html?item_id=${id}`;\r\n            } else if (action === 'contact') {\r\n                const sellerId = btn.dataset.sellerId;\r\n                window.location.href = `messages.html?partner_id=${sellerId}`;\r\n            } else if (action === 'view') {\r\n                const isAuth = await isLoggedIn();\r\n                if (isAuth) {\r\n                    window.location.href = `item.html?id=${id}`;\r\n                } else {\r\n                    document.dispatchEvent(new CustomEvent('open-auth-modal'));\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    // Resource Grid Actions\r\n    if (resourcesGrid) {\r\n        resourcesGrid.addEventListener('click', (e) => {\r\n            const btn = e.target.closest('.download-btn');\r\n            if (btn) {\r\n                const card = btn.closest('.resource-card');\r\n                if (card) {\r\n                    handleDownloadAction(card.dataset.id);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    // Modal Handling (Auth & Post)\r\n    document.addEventListener('open-auth-modal', () => {\r\n        if (authModal) authModal.classList.add('active');\r\n    });\r\n\r\n    document.addEventListener('open-post-modal', () => {\r\n        if (uploadModal) uploadModal.classList.add('active');\r\n    });\r\n\r\n    // Close Modals\r\n    document.querySelectorAll('.modal-close').forEach(btn => {\r\n        btn.addEventListener('click', () => {\r\n            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));\r\n        });\r\n    });\r\n\r\n    window.addEventListener('click', (e) => {\r\n        if (e.target.classList.contains('modal')) {\r\n            e.target.classList.remove('active');\r\n        }\r\n    });\r\n\r\n    // Auth Tabs\r\n    const authTabs = document.querySelectorAll('.auth-tab');\r\n    authTabs.forEach(tab => {\r\n        tab.addEventListener('click', () => {\r\n            authTabs.forEach(t => t.classList.remove('active'));\r\n            tab.classList.add('active');\r\n\r\n            const mode = tab.dataset.tab;\r\n            if (mode === 'login') {\r\n                document.getElementById('loginForm').style.display = 'block';\r\n                document.getElementById('registerForm').style.display = 'none';\r\n                document.getElementById('authModalTitle').textContent = 'Login';\r\n            } else {\r\n                document.getElementById('loginForm').style.display = 'none';\r\n                document.getElementById('registerForm').style.display = 'block';\r\n                document.getElementById('authModalTitle').textContent = 'Register';\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n// Helper: Resource Upload\r\nasync function handleResourceUpload(e) {\r\n    e.preventDefault();\r\n    if (!await isLoggedIn()) {\r\n        alert(\"Please login to upload resources.\");\r\n        return;\r\n    }\r\n    const user = await getCurrentUser();\r\n\r\n    const newResource = {\r\n        title: document.getElementById('resourceTitle').value,\r\n        type: document.getElementById('resourceType').value,\r\n        course: document.getElementById('resourceCourse').value,\r\n        year: parseInt(document.getElementById('resourceYear').value) || new Date().getFullYear(),\r\n        description: document.getElementById('resourceDescription').value,\r\n        uploader_id: user.id\r\n    };\r\n\r\n    const { error } = await supabase.from('free_resources').insert([newResource]);\r\n    if (error) {\r\n        alert(\"Error uploading resource: \" + error.message);\r\n    } else {\r\n        alert(\"Resource uploaded!\");\r\n        document.getElementById('resourceModal').classList.remove('active'); // simplistic close\r\n        fetchResources();\r\n    }\r\n}\r\n\r\nasync function handleDownloadAction(id) {\r\n    if (!await isLoggedIn()) {\r\n        document.dispatchEvent(new CustomEvent('open-auth-modal'));\r\n        return;\r\n    }\r\n    await addDownload({ id });\r\n    alert(\"Download started!\");\r\n}\r\n\r\n// Helper: Debounce\r\nfunction debounce(func, wait) {\r\n    let timeout;\r\n    return function (...args) {\r\n        clearTimeout(timeout);\r\n        timeout = setTimeout(() => func.apply(this, args), wait);\r\n    };\r\n}\r\n\r\n// Helper: Search\r\nasync function handleSearch(e) {\r\n    const query = e.target.value.toLowerCase();\r\n\r\n    const { data: items, error } = await supabase\r\n        .from('market_listings')\r\n        .select(`\r\n            *,\r\n            profiles (\r\n                username,\r\n                full_name\r\n            )\r\n        `)\r\n        .or(`title.ilike.%${query}%,description.ilike.%${query}%`)\r\n        .eq('status', 'active');\r\n\r\n    if (error) console.error('Search error:', error);\r\n\r\n    const isAuth = await isLoggedIn();\r\n    if (marketplaceGrid) {\r\n        marketplaceGrid.innerHTML = (items || []).map(item => createItemCard(item, isAuth)).join('');\r\n    }\r\n}\r\n\r\n// Helper: Client-side Filter\r\nasync function filterMarketplace(category) {\r\n    const isAuth = await isLoggedIn();\r\n    const { data: items, error } = await supabase\r\n        .from('market_listings')\r\n        .select(`\r\n            *,\r\n            profiles (\r\n                username,\r\n                full_name\r\n            )\r\n        `)\r\n        .eq('status', 'active')\r\n        .order('created_at', { ascending: false });\r\n\r\n    if (error) console.error('Filter error:', error);\r\n\r\n    const filtered = category === 'all'\r\n        ? items\r\n        : (items || []).filter(i => i.category === category);\r\n\r\n    if (marketplaceGrid) {\r\n        marketplaceGrid.innerHTML = (filtered || []).map(item => createItemCard(item, isAuth)).join('');\r\n    }\r\n}\r\n"],"names":["getCurrentUser","user","supabase","profile","profileError","userProfile","purchases","listings","sellerListingsForSales","downloads","savedItems","uploadedResources","r","e","sales","myItemIds","l","salesData","_a","_b","_c","_d","_e","error","checkAuth","supabaseUrl","supabaseAnonKey","createClient","registerUser","email","password","userData","firstName","lastName","username","phone","role","authData","authError","loginUser","data","getCurrentSession","session","isLoggedIn","addDownload","resource","initNavigation","setupMobileMenu","renderDesktopNav","menuToggle","navLinks","navContent","isAuth","gridIcon","userIcon","basePage","browseHtml","rightNavHtml","isSeller","linksHtml","logoHtml","navSearchHtml","mobileToggleHtml","attachEventListeners","dropdown","trigger","menu","isOpen","closeAllDropdowns","logoutHandler","logoutUser","logoutBtnMenu","logoutBtnNav","postItemHandler","postItemBtnMenu","postItemBtnNav","loginBtn","authModal","signupBtn","navSearchInput","d","fetchAllItems","publicData","publicError","createItemCard","item","postedDate","mainImage","createAuthenticatedCard","createPublicCard","sellerName","sellerId","escapeHtml","text","div","toggleSaveItem","itemId","existing","fetchError","deleteError","insertError","initSaveListeners","btn","result","currentResourceType","resources","uploadModal","resourceForm","loginForm","registerForm","marketplaceGrid","resourcesGrid","updateAuthUI","refreshMarketplace","fetchResources","setupEventListeners","event","currentPath","heroSection","trustSection","howItWorksSection","heroAuthCtas","setupHeroListeners","marketplace","items","renderResources","filteredResources","createResourceCard","icons","activeSearchInput","debounce","handleSearch","categoryButtons","button","resourceChips","chip","c","handleResourceUpload","action","id","card","handleDownloadAction","m","authTabs","tab","t","newResource","func","wait","timeout","args","query"],"mappings":"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"}