{"version":3,"file":"messages-RBzq9viy.js","sources":["../../messages.js"],"sourcesContent":["import { supabase } from './supabase-config.js';\r\nimport { isLoggedIn, getCurrentUser } from './auth.js';\r\n\r\n// State\r\nlet currentConversationId = null;\r\nlet currentUser = null;\r\nlet realtimeSubscription = null;\r\n\r\n// DOM Elements\r\nconst conversationsList = document.getElementById('conversationsList');\r\nconst chatArea = document.getElementById('chatArea');\r\n\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n    // 1. Auth Guard\r\n    const loggedIn = await isLoggedIn();\r\n    if (!loggedIn) {\r\n        window.location.href = 'index.html';\r\n        return;\r\n    }\r\n\r\n    currentUser = await getCurrentUser();\r\n\r\n    // 2. Initialize UI\r\n    setupSearch();\r\n\r\n    // 3. Check for specific conversation in URL (from listings)\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const sellerId = urlParams.get('seller_id');\r\n    const listingId = urlParams.get('listing_id');\r\n\r\n    if (sellerId && listingId) {\r\n        await startOrOpenConversation(sellerId, listingId);\r\n    }\r\n\r\n    // 4. Load Inbox\r\n    loadInbox();\r\n\r\n    // 5. Global Realtime for Inbox Updates\r\n    subscribeToInbox();\r\n});\r\n\r\n/**\r\n * Loads the list of conversations for the current user.\r\n */\r\nasync function loadInbox() {\r\n    if (!currentUser) return;\r\n\r\n    try {\r\n        const { data: conversations, error } = await supabase\r\n            .from('conversations')\r\n            .select(`\r\n                *,\r\n                item:market_listings(title, price, image_url),\r\n                buyer:profiles!buyer_id(username, avatar_url),\r\n                seller:profiles!seller_id(username, avatar_url)\r\n            `)\r\n            .or(`buyer_id.eq.${currentUser.id},seller_id.eq.${currentUser.id}`)\r\n            .order('updated_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        // For each conversation, fetch the last message\r\n        const inboxData = await Promise.all(conversations.map(async (conv) => {\r\n            const { data: lastMsg } = await supabase\r\n                .from('messages')\r\n                .select('*')\r\n                .eq('conversation_id', conv.id)\r\n                .order('created_at', { ascending: false })\r\n                .limit(1)\r\n                .single();\r\n\r\n            const isBuyer = conv.buyer_id === currentUser.id;\r\n            const partner = isBuyer ? conv.seller : conv.buyer;\r\n            const partnerId = isBuyer ? conv.seller_id : conv.buyer_id;\r\n\r\n            // Get partner's immutable code for display\r\n            const { data: partnerProfile } = await supabase\r\n                .from('profiles')\r\n                .select('immutable_user_code')\r\n                .eq('id', partnerId)\r\n                .single();\r\n\r\n            // Count unread\r\n            const { count: unreadCount } = await supabase\r\n                .from('messages')\r\n                .select('*', { count: 'exact', head: true })\r\n                .eq('conversation_id', conv.id)\r\n                .is('read_at', null)\r\n                .neq('sender_id', currentUser.id);\r\n\r\n            return {\r\n                ...conv,\r\n                partnerName: partner?.username || 'User',\r\n                partnerId: partnerId,\r\n                displayId: partnerProfile?.immutable_user_code || partnerId.slice(0, 6).toUpperCase(),\r\n                lastMessage: lastMsg?.content || (lastMsg?.message_type !== 'text' ? 'Sent a file' : 'No messages yet'),\r\n                lastTime: lastMsg ? formatTime(lastMsg.created_at) : '',\r\n                unreadCount: unreadCount || 0\r\n            };\r\n        }));\r\n\r\n        renderInbox(inboxData);\r\n    } catch (err) {\r\n        console.error('Inbox load error:', err);\r\n    }\r\n}\r\n\r\nfunction renderInbox(data) {\r\n    if (!conversationsList) return;\r\n    if (data.length === 0) {\r\n        conversationsList.innerHTML = '<div class=\"p-8 text-center text-gray-400\">No conversations yet.</div>';\r\n        return;\r\n    }\r\n\r\n    conversationsList.innerHTML = data.map(conv => `\r\n        <div class=\"conversation-item ${conv.id === currentConversationId ? 'active' : ''}\" \r\n             onclick=\"window.selectConversation('${conv.id}')\">\r\n            <div style=\"display:flex; justify-content:space-between; align-items:flex-start;\">\r\n                <div>\r\n                    <span style=\"font-weight:700; color:var(--text-main); font-size:0.95rem;\">${escapeHtml(conv.partnerName)}</span>\r\n                    <div style=\"font-size:0.7rem; color:var(--text-muted);\">ID: ${conv.displayId}</div>\r\n                </div>\r\n                <div style=\"text-align:right;\">\r\n                    <div style=\"font-size:0.75rem; color:var(--text-muted);\">${conv.lastTime}</div>\r\n                    ${conv.unreadCount > 0 ? `<span style=\"display:inline-block; background:var(--primary-color); color:white; font-size:0.7rem; padding:1px 6px; border-radius:10px; font-weight:700; margin-top:4px;\">${conv.unreadCount}</span>` : ''}\r\n                </div>\r\n            </div>\r\n            <div style=\"font-size:0.85rem; color:var(--text-secondary); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; ${conv.unreadCount > 0 ? 'font-weight:600;' : ''}\">\r\n                ${escapeHtml(conv.lastMessage || '')}\r\n            </div>\r\n            ${conv.item ? `<div style=\"font-size:0.75rem; color:var(--primary-color); font-weight:600; margin-top:4px;\">Item: ${escapeHtml(conv.item.title)}</div>` : ''}\r\n        </div>\r\n    `).join('');\r\n}\r\n\r\nwindow.selectConversation = async (id) => {\r\n    currentConversationId = id;\r\n    renderInboxActiveState();\r\n    await loadChat(id);\r\n};\r\n\r\nfunction renderInboxActiveState() {\r\n    document.querySelectorAll('.conversation-item').forEach(el => {\r\n        el.classList.remove('active');\r\n        if (el.getAttribute('onclick')?.includes(currentConversationId)) {\r\n            el.classList.add('active');\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Loads the messages for a specific conversation.\r\n */\r\nasync function loadChat(convId) {\r\n    if (!chatArea) return;\r\n    chatArea.innerHTML = '<div class=\"flex items-center justify-center h-full\"><div class=\"spinner\"></div></div>';\r\n\r\n    try {\r\n        const { data: messages, error } = await supabase\r\n            .from('messages')\r\n            .select('*')\r\n            .eq('conversation_id', convId)\r\n            .order('created_at', { ascending: true });\r\n\r\n        if (error) throw error;\r\n\r\n        const { data: conv } = await supabase\r\n            .from('conversations')\r\n            .select('*, item:market_listings(*), buyer:profiles!buyer_id(username), seller:profiles!seller_id(username)')\r\n            .eq('id', convId)\r\n            .single();\r\n\r\n        const partner = conv.buyer_id === currentUser.id ? conv.seller : conv.buyer;\r\n        const partnerId = conv.buyer_id === currentUser.id ? conv.seller_id : conv.buyer_id;\r\n\r\n        // Ensure we have the code for the chat header too\r\n        const { data: pProfile } = await supabase.from('profiles').select('immutable_user_code').eq('id', partnerId).single();\r\n        const displayId = pProfile?.immutable_user_code || partnerId.slice(0, 6).toUpperCase();\r\n\r\n        renderChatWindow(messages, partner?.username || 'User', displayId, conv.item);\r\n\r\n        // Mark as read\r\n        markAsRead(convId);\r\n\r\n        // Subscribe to real-time messages\r\n        subscribeToChat(convId);\r\n\r\n    } catch (err) {\r\n        console.error('Chat load error:', err);\r\n    }\r\n}\r\n\r\nfunction renderChatWindow(messages, partnerName, displayId, item) {\r\n    chatArea.innerHTML = `\r\n        <div class=\"chat-header\">\r\n            <div>\r\n                <h3 style=\"font-weight:700; font-size:1.1rem;\">${escapeHtml(partnerName)}</h3>\r\n                <span style=\"font-size:0.75rem; color:var(--text-muted);\">User ID: ${displayId}</span>\r\n            </div>\r\n        </div>\r\n        ${item ? `\r\n            <div class=\"chat-item-header\">\r\n                <img src=\"${item.image_url || 'https://via.placeholder.com/40'}\" class=\"chat-item-img\">\r\n                <div class=\"chat-item-info\">\r\n                    <div class=\"chat-item-title\">${escapeHtml(item.title)}</div>\r\n                    <div class=\"chat-item-price\">R ${item.price}</div>\r\n                </div>\r\n                <a href=\"listings.html?id=${item.id}\" class=\"action-btn\" style=\"padding:4px 12px; font-size:0.8rem;\">View Item</a>\r\n            </div>\r\n        ` : ''}\r\n        <div id=\"messagesList\" class=\"messages-list\">\r\n            ${messages.map(msg => renderMessage(msg)).join('')}\r\n        </div>\r\n        <div class=\"chat-input-area\">\r\n            <div class=\"upload-btn-wrapper\">\r\n                <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48\"></path></svg>\r\n                <input type=\"file\" id=\"fileAttach\" onchange=\"window.handleChatUpload(this)\">\r\n            </div>\r\n            <textarea id=\"msgInput\" class=\"message-input\" placeholder=\"Type a message...\" rows=\"1\"></textarea>\r\n            <button onclick=\"window.sendChatMessage()\" class=\"send-btn\">Send</button>\r\n        </div>\r\n    `;\r\n\r\n    const list = document.getElementById('messagesList');\r\n    list.scrollTop = list.scrollHeight;\r\n\r\n    // Enter key support\r\n    document.getElementById('msgInput').addEventListener('keypress', (e) => {\r\n        if (e.key === 'Enter' && !e.shiftKey) {\r\n            e.preventDefault();\r\n            window.sendChatMessage();\r\n        }\r\n    });\r\n}\r\n\r\nfunction renderMessage(msg) {\r\n    const isMe = msg.sender_id === currentUser.id;\r\n    let contentHtml = escapeHtml(msg.content || '');\r\n\r\n    if (msg.message_type === 'image') {\r\n        contentHtml = `<img src=\"${msg.file_url}\" style=\"max-width:100%; border-radius:8px; display:block;\">`;\r\n    } else if (msg.message_type === 'file') {\r\n        contentHtml = `<a href=\"${msg.file_url}\" target=\"_blank\" class=\"attachment-file\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z\"></path><polyline points=\"13 2 13 9 20 9\"></polyline></svg> Document</a>`;\r\n    }\r\n\r\n    return `\r\n        <div class=\"message-bubble ${isMe ? 'message-sent' : 'message-received'}\">\r\n            ${contentHtml}\r\n            <div class=\"read-status\">\r\n                ${formatTimeShort(msg.created_at)}\r\n                ${isMe ? (msg.read_at ? ' • Seen' : ' • Sent') : ''}\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nwindow.sendChatMessage = async () => {\r\n    const input = document.getElementById('msgInput');\r\n    const content = input.value.trim();\r\n    if (!content || !currentConversationId) return;\r\n\r\n    input.value = '';\r\n\r\n    // Get partner ID from existing current chat\r\n    const { data: conv } = await supabase.from('conversations').select('buyer_id, seller_id').eq('id', currentConversationId).single();\r\n    const receiverId = conv.buyer_id === currentUser.id ? conv.seller_id : conv.buyer_id;\r\n\r\n    const { error } = await supabase\r\n        .from('messages')\r\n        .insert([{\r\n            conversation_id: currentConversationId,\r\n            sender_id: currentUser.id,\r\n            receiver_id: receiverId,\r\n            content: content,\r\n            message_type: 'text'\r\n        }]);\r\n\r\n    if (error) console.error('Send error:', error);\r\n};\r\n\r\nwindow.handleChatUpload = async (input) => {\r\n    const file = input.files[0];\r\n    if (!file || !currentConversationId) return;\r\n\r\n    const fileName = `${Date.now()}_${file.name}`;\r\n    const filePath = `${currentUser.id}/${fileName}`;\r\n\r\n    try {\r\n        const { error: uploadError } = await supabase.storage\r\n            .from('chat-attachments')\r\n            .upload(filePath, file);\r\n\r\n        if (uploadError) throw uploadError;\r\n\r\n        const { data: { publicUrl } } = supabase.storage\r\n            .from('chat-attachments')\r\n            .getPublicUrl(filePath);\r\n\r\n        const { data: conv } = await supabase.from('conversations').select('buyer_id, seller_id').eq('id', currentConversationId).single();\r\n        const receiverId = conv.buyer_id === currentUser.id ? conv.seller_id : conv.buyer_id;\r\n\r\n        const type = file.type.startsWith('image/') ? 'image' : 'file';\r\n\r\n        await supabase.from('messages').insert([{\r\n            conversation_id: currentConversationId,\r\n            sender_id: currentUser.id,\r\n            receiver_id: receiverId,\r\n            message_type: type,\r\n            file_url: publicUrl\r\n        }]);\r\n\r\n    } catch (err) {\r\n        console.error('Upload Error:', err);\r\n        alert('Failed to upload file.');\r\n    }\r\n};\r\n\r\n/**\r\n * Real-time Subscriptions\r\n */\r\nfunction subscribeToChat(convId) {\r\n    if (realtimeSubscription) supabase.removeChannel(realtimeSubscription);\r\n\r\n    realtimeSubscription = supabase\r\n        .channel(`chat:${convId}`)\r\n        .on('postgres_changes', {\r\n            event: '*',\r\n            schema: 'public',\r\n            table: 'messages',\r\n            filter: `conversation_id=eq.${convId}`\r\n        }, payload => {\r\n            if (payload.eventType === 'INSERT') {\r\n                const list = document.getElementById('messagesList');\r\n                if (list) {\r\n                    const div = document.createElement('div');\r\n                    div.innerHTML = renderMessage(payload.new);\r\n                    list.appendChild(div.firstElementChild);\r\n                    list.scrollTop = list.scrollHeight;\r\n\r\n                    if (payload.new.sender_id !== currentUser.id) {\r\n                        markAsRead(convId);\r\n                    }\r\n                }\r\n            } else if (payload.eventType === 'UPDATE') {\r\n                // If a message was marked as read, we might want to update the bubble\r\n                loadChat(convId); // Simple refresh for now\r\n            }\r\n        })\r\n        .subscribe();\r\n}\r\n\r\nfunction subscribeToInbox() {\r\n    supabase\r\n        .channel('inbox-updates')\r\n        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {\r\n            loadInbox();\r\n        })\r\n        .subscribe();\r\n}\r\n\r\nasync function markAsRead(convId) {\r\n    await supabase\r\n        .from('messages')\r\n        .update({ read_at: new Date().toISOString() })\r\n        .eq('conversation_id', convId)\r\n        .neq('sender_id', currentUser.id)\r\n        .is('read_at', null);\r\n}\r\n\r\n/**\r\n * Conversation Creation Logic (Contact Seller Button Redirect)\r\n */\r\nasync function startOrOpenConversation(sellerId, listingId) {\r\n    if (sellerId === currentUser.id) {\r\n        alert(\"You cannot message yourself.\");\r\n        return;\r\n    }\r\n\r\n    try {\r\n        // Find existing\r\n        const { data: existing } = await supabase\r\n            .from('conversations')\r\n            .select('id')\r\n            .eq('listing_id', listingId)\r\n            .eq('buyer_id', currentUser.id)\r\n            .eq('seller_id', sellerId)\r\n            .single();\r\n\r\n        if (existing) {\r\n            window.selectConversation(existing.id);\r\n            return;\r\n        }\r\n\r\n        // Create new\r\n        const { data: newConv, error } = await supabase\r\n            .from('conversations')\r\n            .insert([{\r\n                listing_id: listingId,\r\n                buyer_id: currentUser.id,\r\n                seller_id: sellerId\r\n            }])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n        window.selectConversation(newConv.id);\r\n\r\n    } catch (err) {\r\n        console.error('Conv Error:', err);\r\n    }\r\n}\r\n\r\n/**\r\n * UI Helpers\r\n */\r\nfunction formatTime(iso) {\r\n    const d = new Date(iso);\r\n    const now = new Date();\r\n    if (d.toDateString() === now.toDateString()) {\r\n        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n    }\r\n    return d.toLocaleDateString([], { month: 'short', day: 'numeric' });\r\n}\r\n\r\nfunction formatTimeShort(iso) {\r\n    const d = new Date(iso);\r\n    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n}\r\n\r\nfunction escapeHtml(text) {\r\n    if (!text) return '';\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n}\r\n\r\nfunction setupSearch() {\r\n    const input = document.getElementById('convSearch');\r\n    if (!input) return;\r\n    input.addEventListener('input', (e) => {\r\n        const query = e.target.value.toLowerCase();\r\n        document.querySelectorAll('.conversation-item').forEach(item => {\r\n            item.style.display = item.textContent.toLowerCase().includes(query) ? 'block' : 'none';\r\n        });\r\n    });\r\n}\r\n"],"names":["currentConversationId","currentUser","realtimeSubscription","conversationsList","chatArea","isLoggedIn","getCurrentUser","setupSearch","urlParams","sellerId","listingId","startOrOpenConversation","loadInbox","subscribeToInbox","conversations","error","supabase","inboxData","conv","lastMsg","isBuyer","partner","partnerId","partnerProfile","unreadCount","formatTime","renderInbox","err","data","escapeHtml","id","renderInboxActiveState","loadChat","el","_a","convId","messages","pProfile","displayId","renderChatWindow","markAsRead","subscribeToChat","partnerName","item","msg","renderMessage","list","e","isMe","contentHtml","formatTimeShort","input","content","receiverId","file","fileName","filePath","uploadError","publicUrl","type","payload","div","existing","newConv","iso","d","now","text","query"],"mappings":"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"}