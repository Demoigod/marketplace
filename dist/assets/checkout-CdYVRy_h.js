import{g as E,s as u,b as $}from"./auth-B4SlU3WG.js";document.addEventListener("DOMContentLoaded",async()=>{T(),await U(),A()});function T(){const t=document.getElementById("currentDate");if(t){const e=new Date,o={month:"long",day:"numeric",year:"numeric"};t.textContent=`Today is ${e.toLocaleDateString("en-US",o)}`}}async function U(){const t=await E();t&&(I(t),document.getElementById("countListings")&&F(t.id),(document.getElementById("activityFeed1")||document.getElementById("notificationFeed"))&&M(),document.getElementById("myListingsFeed")&&(S(t.id),D(t.id)),k(t.id),q(t.id))}async function S(t){const e=document.getElementById("myListingsFeed"),o=document.getElementById("myListingsCountBadge");if(e)try{const{data:n,error:l}=await u.from("market_listings").select("title, price, status, created_at").eq("seller_id",t).order("created_at",{ascending:!1});if(l)throw l;o&&(o.textContent=n.length);const r=document.getElementById("countListings");if(r&&(r.textContent=n.length),n.length===0){e.innerHTML=`<div class="p-4 text-center text-gray-500">You haven't posted anything yet.</div>`;return}e.innerHTML=n.map(s=>`
            <div class="activity-item">
                <div class="logo-box" style="background: #F8F9FA; color: var(--primary-color); width: 32px; height: 32px;">
                    <span style="font-size: 0.8rem; font-weight: 800;">ðŸ›’</span>
                </div>
                <div class="act-body">
                    <span class="act-user">${s.title}</span>
                    <span class="act-desc">R ${s.price} â€¢ <span class="status-tag ${s.status}">${s.status.toUpperCase()}</span></span>
                </div>
                <span class="act-time">${new Date(s.created_at).toLocaleDateString()}</span>
            </div>
        `).join("")}catch(n){console.error("Error loading my listings:",n),e.innerHTML='<div class="p-4 text-red-500">Could not load your listings.</div>'}}function D(t){u.channel("my-listings-changes").on("postgres_changes",{event:"*",schema:"public",table:"market_listings",filter:`seller_id=eq.${t}`},e=>{console.log("Real-time listing change detected:",e.eventType),S(t)}).subscribe()}async function F(t){try{const{count:e}=await u.from("market_listings").select("*",{count:"exact",head:!0}).eq("seller_id",t);document.getElementById("countListings").textContent=e||0,document.getElementById("countMessages").textContent="12",document.getElementById("unreadBadge").textContent="6",document.getElementById("countResources").textContent="6",document.getElementById("countSales").textContent="3"}catch(e){console.error("Error loading metrics:",e)}}function M(){const t=document.getElementById("activityFeed1"),e=document.getElementById("activityFeed2"),o=document.getElementById("notificationFeed"),n=[{name:"John Doe",action:"Bought item from seller",time:"30 mins ago"},{name:"Jane Smith",action:"Listed a new textbook",time:"1 hour ago"},{name:"Alex Brown",action:"Commented on your post",time:"2 hours ago"}],l=[{name:"John Doe",desc:"sent you a message",time:"10 mins ago"},{name:"System",desc:"Your document was approved",time:"1 hour ago"},{name:"Market",desc:"New comment on your listing",time:"2 hours ago"}];t&&(t.innerHTML=n.map(r=>_(r)).join("")),e&&(e.innerHTML=n.map(r=>_(r)).join("")),o&&(o.innerHTML=l.map(r=>N(r)).join(""))}function _(t){return`
        <div class="activity-item">
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}&background=random" class="act-avatar">
            <div class="act-body">
                <span class="act-user">${t.name}</span>
                <span class="act-desc">${t.action}</span>
            </div>
            <span class="act-time">${t.time}</span>
        </div>
    `}function N(t){return`
        <div class="activity-item">
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}&background=F1F3F5&color=368CBF" class="act-avatar" style="border-radius: 8px;">
            <div class="act-body">
                <span class="act-user">${t.name} ${t.desc}</span>
                <span class="act-time">${t.time}</span>
            </div>
            <span style="color: #ADB5BD; font-size: 1.2rem;">...</span>
        </div>
    `}function A(){const t=document.querySelector(".sidebar");if(!t)return;const e=window.location.pathname.split("/").pop()||"admin.html";document.querySelectorAll(".nav-link").forEach(n=>{n.getAttribute("href")===e?n.classList.add("active"):n.classList.remove("active")}),t.addEventListener("click",async n=>{const l=n.target.closest(".nav-link");if(!l)return;if(l.id==="sidebarLogout"){n.preventDefault(),R();return}const r=l.getAttribute("href");if(r==="#"||!r){n.preventDefault();return}const{data:{session:s}}=await u.auth.getSession();if(!s&&r!=="index.html"){n.preventDefault(),window.location.href="index.html";return}});const o=document.getElementById("profileToggle");o&&o.addEventListener("click",()=>{window.location.href="account.html"}),I()}async function I(t=null){console.log("--- SYNC ATTEMPT START ---");try{const e=t||await E();if(!e){console.warn("Sync aborted: User object not found.");return}const o=()=>{var x,B,L;const n=String(e.first_name||((x=e.user_metadata)==null?void 0:x.first_name)||""),l=String(e.last_name||((B=e.user_metadata)==null?void 0:B.last_name)||""),r=String(e.username||((L=e.user_metadata)==null?void 0:L.username)||"User"),s=String(e.email||""),C=String(e.phone||e.phone_number||""),w=String(e.immutable_user_code||(e.id?e.id.slice(0,6).toUpperCase():"000000"));let g=r;n&&(g=`${n} ${l}`.trim()),g==="User"&&n&&(g=`${n} ${l}`.trim());const f=e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(g)}&background=368CBF&color=fff`;[{id:"userName",attr:"textContent",val:g},{id:"welcomeTitle",attr:"textContent",val:`Welcome, ${n||r} ðŸ‘‹`},{id:"userId",attr:"textContent",val:`ID: ${w}`},{id:"profileFullName",attr:"textContent",val:g},{id:"profileRole",attr:"textContent",val:(e.role||"Member").charAt(0).toUpperCase()+(e.role||"Member").slice(1)},{id:"publicUserIdDisplay",attr:"textContent",val:`ID: #${w}`},{id:"topNavAvatar",attr:"src",val:f},{id:"userAvatar",attr:"src",val:f},{id:"profileAvatar",attr:"src",val:f},{id:"firstName",attr:"value",val:n},{id:"lastName",attr:"value",val:l},{id:"username",attr:"value",val:r},{id:"email",attr:"value",val:s},{id:"phone",attr:"value",val:C}].forEach(a=>{const d=document.getElementById(a.id);d&&(a.attr==="value"?(d.value=a.val,d.placeholder=a.val||"Not provided"):d[a.attr]=a.val)});const h=document.getElementById("profileAvatar");if(h&&!h.closest(".avatar-upload-wrapper")){console.log("Detected cached HTML: Injecting Avatar Upload UI...");const a=document.createElement("div");a.className="avatar-upload-wrapper",a.style.position="relative",a.style.display="inline-block";const d=h.cloneNode(!0);a.appendChild(d);const p=document.createElement("label");p.className="avatar-edit-overlay",p.htmlFor="avatarInput",p.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',a.appendChild(p);const i=document.createElement("input");if(i.type="file",i.id="avatarInput",i.accept="image/*",i.style.display="none",a.appendChild(i),h.parentNode.insertBefore(a,h),h.remove(),!document.getElementById("avatar-styles")){const m=document.createElement("style");m.id="avatar-styles",m.textContent=`
                        .avatar-edit-overlay { position: absolute; bottom: 0; right: 0; background: #368CBF; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; transition: transform 0.2s; }
                        .avatar-edit-overlay:hover { transform: scale(1.1); }
                    `,document.head.appendChild(m)}}const c=document.getElementById("username");if(c&&c.hasAttribute("readonly")&&document.querySelector(".profile-form")){if(console.log("Detected cached HTML: Injecting Username Edit UI..."),c.removeAttribute("readonly"),c.placeholder="Choose a unique username",c.autocomplete="off",c.classList.add("editable-username"),!document.getElementById("usernameFeedback")){const i=document.createElement("small");i.id="usernameFeedback",i.style.display="block",i.style.marginTop="4px",i.style.fontSize="0.75rem",i.style.minHeight="1.2em",c.parentNode.appendChild(i)}if(!document.getElementById("saveProfileBtn")){const i=document.createElement("div");i.className="form-actions",i.style.marginTop="0.5rem",i.style.textAlign="right",i.innerHTML='<button id="saveProfileBtn" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 6px; border: none; background: #368CBF; color: white; font-weight: 600; cursor: pointer; opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">Save Changes</button>',c.parentNode.parentNode.appendChild(i),c.parentNode.after(i)}const a=document.getElementById("saveProfileBtn"),d=document.getElementById("usernameFeedback");let p=c.value;c.addEventListener("focus",()=>{p||(p=c.value)}),c.addEventListener("input",i=>{const m=i.target.value.trim(),v=/^[a-zA-Z0-9_]{3,20}$/.test(m);m===p?(a.style.opacity="0.5",a.style.pointerEvents="none",d.textContent="",c.style.borderColor="#d1d5db"):v?(a.style.opacity="1",a.style.pointerEvents="auto",d.textContent="Looks good!",d.style.color="green",c.style.borderColor="green"):(a.style.opacity="0.5",a.style.pointerEvents="none",d.textContent="Invalid format (3-20 chars, alphanumeric/_)",d.style.color="red",c.style.borderColor="red")}),a.addEventListener("click",async()=>{const i=c.value.trim();a.textContent="Saving...",a.disabled=!0;try{const{data:{user:m}}=await u.auth.getUser();if(!m)throw new Error("Not logged in");const{error:v}=await u.from("profiles").update({username:i}).eq("id",m.id);if(v)throw v.code==="23505"?new Error("Username taken"):v;alert("Username updated!"),p=i,a.textContent="Saved",setTimeout(()=>{a.textContent="Save Changes",a.style.opacity="0.5",a.style.pointerEvents="none"},2e3)}catch(m){alert(m.message),a.textContent="Save Changes",a.disabled=!1}})}console.log("--- SYNC SUCCESSFUL ---")};o(),setTimeout(o,300)}catch(e){console.error("CRITICAL ERROR during Profile UI sync:",e)}}window.syncProfileUI=I;async function R(){if(confirm("Are you sure you want to logout?"))try{await $(),window.location.href="index.html"}catch(t){console.error("Logout failed:",t),window.location.href="index.html"}}async function k(t){try{const{count:e,error:o}=await u.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_id",t).is("read_at",null);if(o)throw o;const n=document.getElementById("unreadBadge");n&&(n.textContent=e||0,n.style.display=e>0?"flex":"none");const l=document.getElementById("countMessages");l&&(l.textContent=e||0);const r=document.querySelector('a[href="messages.html"]');if(r&&e>0){let s=r.querySelector(".sidebar-badge");s||(s=document.createElement("span"),s.className="sidebar-badge",s.style="background: #E63946; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto; font-weight: 700;",r.appendChild(s)),s.textContent=e}else if(r){const s=r.querySelector(".sidebar-badge");s&&s.remove()}}catch(e){console.error("Error loading unread count:",e)}}function q(t){u.channel("global-unread-sync").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${t}`},()=>{k(t)}).subscribe()}let y=null,b=null;document.addEventListener("DOMContentLoaded",async()=>{const e=new URLSearchParams(window.location.search).get("id");if(!e){window.location.href="listings.html";return}try{if(b=await E(),!b){window.location.href="index.html";return}P(b),await H(e)}catch(o){console.error("Checkout Init Error:",o),alert("Could not initialize checkout."),window.location.href="listings.html"}});function P(t){const e=document.getElementById("buyerName"),o=document.getElementById("buyerId");e&&(e.textContent=t.username||"User"),o&&(o.textContent=`ID: ${t.immutable_user_code}`)}async function H(t){var g,f;const e=document.getElementById("checkoutLoading"),o=document.getElementById("checkoutUI");e.style.display="block",o.style.visibility="hidden";const{data:n,error:l}=await u.from("market_listings").select(`
            *,
            profiles (username, immutable_user_code)
        `).eq("id",t).single();if(l||!n){alert("Item not found or unavailable."),window.location.href="listings.html";return}if(n.status!=="active"){alert("This item has already been sold or removed."),window.location.href="listings.html";return}y=n;const r=document.getElementById("itemSummaryCard"),s=document.getElementById("totalAmount"),C=document.getElementById("confirmOrderBtn"),w=n.image_url||n.images&&n.images[0]||"https://via.placeholder.com/80";r.innerHTML=`
        <img src="${w}" class="summary-img">
        <div class="summary-info">
            <h3>${n.title}</h3>
            <div class="price">R ${parseFloat(n.price).toLocaleString()}</div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">Seller: ${(g=n.profiles)==null?void 0:g.username} #${(f=n.profiles)==null?void 0:f.immutable_user_code}</div>
        </div>
    `,s.textContent=`R ${parseFloat(n.price).toLocaleString()}`,C.innerHTML=`Confirm & Pay R ${parseFloat(n.price).toLocaleString()}`,e.style.display="none",o.style.visibility="visible"}window.processCheckout=async()=>{if(!y||!b)return;const t=document.getElementById("confirmOrderBtn");t.disabled=!0,t.textContent="Processing...";try{const{data:e,error:o}=await u.from("transactions").insert([{buyer_id:b.id,seller_id:y.seller_id,listing_id:y.id,amount:y.price,status:"completed",payment_method:"simulation"}]).select().single();if(o)throw o;const{error:n}=await u.from("market_listings").update({status:"sold"}).eq("id",y.id);if(n)throw n;confirm(`Payment Successful! You bought ${y.title}. Redirect to messages to coordinate pickup?`)?window.location.href=`messages.html?seller_id=${y.seller_id}&listing_id=${y.id}`:window.location.href="listings.html"}catch(e){console.error("Checkout Process Error:",e),alert("Transaction failed: "+e.message),t.disabled=!1,t.textContent="Try Again"}};
