import{g as L,s as m,l as S}from"./auth-BNhlD6S9.js";document.addEventListener("DOMContentLoaded",async()=>{T(),await M(),$()});function T(){const n=document.getElementById("currentDate");if(n){const e=new Date,r={month:"long",day:"numeric",year:"numeric"};n.textContent=`Today is ${e.toLocaleDateString("en-US",r)}`}}async function M(){const n=await L();n&&(x(n),document.getElementById("countListings")&&A(n.id),(document.getElementById("activityFeed1")||document.getElementById("notificationFeed"))&&F(),document.getElementById("myListingsFeed")&&(k(n.id),N(n.id)),U(n.id),q(n.id))}async function k(n){const e=document.getElementById("myListingsFeed"),r=document.getElementById("myListingsCountBadge");if(e)try{const{data:t,error:i}=await m.from("market_listings").select("title, price, status, created_at").eq("seller_id",n).order("created_at",{ascending:!1});if(i)throw i;r&&(r.textContent=t.length);const s=document.getElementById("countListings");if(s&&(s.textContent=t.length),t.length===0){e.innerHTML=`<div class="p-4 text-center text-gray-500">You haven't posted anything yet.</div>`;return}e.innerHTML=t.map(o=>`
            <div class="activity-item">
                <div class="logo-box" style="background: #F8F9FA; color: var(--primary-color); width: 32px; height: 32px;">
                    <span style="font-size: 0.8rem; font-weight: 800;">üõí</span>
                </div>
                <div class="act-body">
                    <span class="act-user">${o.title}</span>
                    <span class="act-desc">R ${o.price} ‚Ä¢ <span class="status-tag ${o.status}">${o.status.toUpperCase()}</span></span>
                </div>
                <span class="act-time">${new Date(o.created_at).toLocaleDateString()}</span>
            </div>
        `).join("")}catch(t){console.error("Error loading my listings:",t),e.innerHTML='<div class="p-4 text-red-500">Could not load your listings.</div>'}}function N(n){m.channel("my-listings-changes").on("postgres_changes",{event:"*",schema:"public",table:"market_listings",filter:`seller_id=eq.${n}`},e=>{console.log("Real-time listing change detected:",e.eventType),k(n)}).subscribe()}async function A(n){try{const{count:e}=await m.from("market_listings").select("*",{count:"exact",head:!0}).eq("seller_id",n);document.getElementById("countListings").textContent=e||0,document.getElementById("countMessages").textContent="12",document.getElementById("unreadBadge").textContent="6",document.getElementById("countResources").textContent="6",document.getElementById("countSales").textContent="3"}catch(e){console.error("Error loading metrics:",e)}}function F(){const n=document.getElementById("activityFeed1"),e=document.getElementById("activityFeed2"),r=document.getElementById("notificationFeed"),t=[{name:"John Doe",action:"Bought item from seller",time:"30 mins ago"},{name:"Jane Smith",action:"Listed a new textbook",time:"1 hour ago"},{name:"Alex Brown",action:"Commented on your post",time:"2 hours ago"}],i=[{name:"John Doe",desc:"sent you a message",time:"10 mins ago"},{name:"System",desc:"Your document was approved",time:"1 hour ago"},{name:"Market",desc:"New comment on your listing",time:"2 hours ago"}];n&&(n.innerHTML=t.map(s=>B(s)).join("")),e&&(e.innerHTML=t.map(s=>B(s)).join("")),r&&(r.innerHTML=i.map(s=>_(s)).join(""))}function B(n){return`
        <div class="activity-item">
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(n.name)}&background=random" class="act-avatar">
            <div class="act-body">
                <span class="act-user">${n.name}</span>
                <span class="act-desc">${n.action}</span>
            </div>
            <span class="act-time">${n.time}</span>
        </div>
    `}function _(n){return`
        <div class="activity-item">
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(n.name)}&background=F1F3F5&color=368CBF" class="act-avatar" style="border-radius: 8px;">
            <div class="act-body">
                <span class="act-user">${n.name} ${n.desc}</span>
                <span class="act-time">${n.time}</span>
            </div>
            <span style="color: #ADB5BD; font-size: 1.2rem;">...</span>
        </div>
    `}function $(){const n=document.querySelector(".sidebar");if(!n)return;const e=window.location.pathname.split("/").pop()||"admin.html";document.querySelectorAll(".nav-link").forEach(t=>{t.getAttribute("href")===e?t.classList.add("active"):t.classList.remove("active")}),n.addEventListener("click",async t=>{const i=t.target.closest(".nav-link");if(!i)return;if(i.id==="sidebarLogout"){t.preventDefault(),D();return}const s=i.getAttribute("href");if(s==="#"||!s){t.preventDefault();return}const{data:{session:o}}=await m.auth.getSession();if(!o&&s!=="index.html"){t.preventDefault(),window.location.href="index.html";return}});const r=document.getElementById("profileToggle");r&&r.addEventListener("click",()=>{window.location.href="account.html"}),x()}async function x(n=null){console.log("--- SYNC ATTEMPT START ---");try{const e=n||await L();if(!e){console.warn("Sync aborted: User object not found.");return}const r=()=>{var E,w,C;const t=String(e.first_name||((E=e.user_metadata)==null?void 0:E.first_name)||""),i=String(e.last_name||((w=e.user_metadata)==null?void 0:w.last_name)||""),s=String(e.username||((C=e.user_metadata)==null?void 0:C.username)||"User"),o=String(e.email||""),d=String(e.phone||e.phone_number||""),u=String(e.immutable_user_code||(e.id?e.id.slice(0,6).toUpperCase():"000000"));let h=s;t&&(h=`${t} ${i}`.trim()),h==="User"&&t&&(h=`${t} ${i}`.trim());const b=e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(h)}&background=368CBF&color=fff`;[{id:"userName",attr:"textContent",val:h},{id:"welcomeTitle",attr:"textContent",val:`Welcome, ${t||s} üëã`},{id:"userId",attr:"textContent",val:`ID: ${u}`},{id:"profileFullName",attr:"textContent",val:h},{id:"profileRole",attr:"textContent",val:(e.role||"Member").charAt(0).toUpperCase()+(e.role||"Member").slice(1)},{id:"publicUserIdDisplay",attr:"textContent",val:`ID: #${u}`},{id:"topNavAvatar",attr:"src",val:b},{id:"userAvatar",attr:"src",val:b},{id:"profileAvatar",attr:"src",val:b},{id:"firstName",attr:"value",val:t},{id:"lastName",attr:"value",val:i},{id:"username",attr:"value",val:s},{id:"email",attr:"value",val:o},{id:"phone",attr:"value",val:d}].forEach(a=>{const p=document.getElementById(a.id);p&&(a.attr==="value"?(p.value=a.val,p.placeholder=a.val||"Not provided"):p[a.attr]=a.val)});const y=document.getElementById("profileAvatar");if(y&&!y.closest(".avatar-upload-wrapper")){console.log("Detected cached HTML: Injecting Avatar Upload UI...");const a=document.createElement("div");a.className="avatar-upload-wrapper",a.style.position="relative",a.style.display="inline-block";const p=y.cloneNode(!0);a.appendChild(p);const f=document.createElement("label");f.className="avatar-edit-overlay",f.htmlFor="avatarInput",f.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',a.appendChild(f);const l=document.createElement("input");l.type="file",l.id="avatarInput",l.accept="image/*",l.style.display="none",a.appendChild(l);const g=document.createElement("div");if(g.style.marginTop="5px",g.style.marginLeft="-10px",g.innerHTML='<label for="avatarInput" style="font-size: 0.8rem; color: var(--primary-color); cursor: pointer; text-decoration: underline;">Change Photo</label>',y.parentNode.insertBefore(a,y),y.parentNode.insertBefore(g,a.nextSibling),y.remove(),!document.getElementById("avatar-styles")){const v=document.createElement("style");v.id="avatar-styles",v.textContent=`
                        .avatar-edit-overlay { position: absolute; bottom: 0; right: 0; background: #368CBF; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; transition: transform 0.2s; }
                        .avatar-edit-overlay:hover { transform: scale(1.1); }
                    `,document.head.appendChild(v)}}const c=document.getElementById("username");if(c&&c.hasAttribute("readonly")&&document.querySelector(".profile-form")){if(console.log("Detected cached HTML: Injecting Username Edit UI..."),c.removeAttribute("readonly"),c.placeholder="Choose a unique username",c.autocomplete="off",c.classList.add("editable-username"),!document.getElementById("usernameFeedback")){const l=document.createElement("small");l.id="usernameFeedback",l.style.display="block",l.style.marginTop="4px",l.style.fontSize="0.75rem",l.style.minHeight="1.2em",c.parentNode.appendChild(l)}if(!document.getElementById("saveProfileBtn")){const l=document.createElement("div");l.className="form-actions",l.style.marginTop="0.5rem",l.style.textAlign="right",l.innerHTML='<button id="saveProfileBtn" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 6px; border: none; background: #368CBF; color: white; font-weight: 600; cursor: pointer; opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">Save Changes</button>',c.parentNode.parentNode.appendChild(l),c.parentNode.after(l)}const a=document.getElementById("saveProfileBtn"),p=document.getElementById("usernameFeedback");let f=c.value;c.addEventListener("focus",()=>{f||(f=c.value)}),c.addEventListener("input",l=>{const g=l.target.value.trim(),v=/^[a-zA-Z0-9_]{3,20}$/.test(g);g===f?(a.style.opacity="0.5",a.style.pointerEvents="none",p.textContent="",c.style.borderColor="#d1d5db"):v?(a.style.opacity="1",a.style.pointerEvents="auto",p.textContent="Looks good!",p.style.color="green",c.style.borderColor="green"):(a.style.opacity="0.5",a.style.pointerEvents="none",p.textContent="Invalid format (3-20 chars, alphanumeric/_)",p.style.color="red",c.style.borderColor="red")}),a.addEventListener("click",async()=>{const l=c.value.trim();a.textContent="Saving...",a.disabled=!0;try{const{data:{user:g}}=await m.auth.getUser();if(!g)throw new Error("Not logged in");const{error:v}=await m.from("profiles").update({username:l}).eq("id",g.id);if(v)throw v.code==="23505"?new Error("Username taken"):v;alert("Username updated!"),f=l,a.textContent="Saved",setTimeout(()=>{a.textContent="Save Changes",a.style.opacity="0.5",a.style.pointerEvents="none"},2e3)}catch(g){alert(g.message),a.textContent="Save Changes",a.disabled=!1}})}console.log("--- SYNC SUCCESSFUL ---")};r(),setTimeout(r,300)}catch(e){console.error("CRITICAL ERROR during Profile UI sync:",e)}}window.syncProfileUI=x;async function D(){if(confirm("Are you sure you want to logout?"))try{await S(),window.location.href="index.html"}catch(n){console.error("Logout failed:",n),window.location.href="index.html"}}async function U(n){try{const{count:e,error:r}=await m.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_id",n).is("read_at",null);if(r)throw r;const t=document.getElementById("unreadBadge");t&&(t.textContent=e||0,t.style.display=e>0?"flex":"none");const i=document.getElementById("countMessages");i&&(i.textContent=e||0);const s=document.querySelector('a[href="messages.html"]');if(s&&e>0){let o=s.querySelector(".sidebar-badge");o||(o=document.createElement("span"),o.className="sidebar-badge",o.style="background: #E63946; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto; font-weight: 700;",s.appendChild(o)),o.textContent=e}else if(s){const o=s.querySelector(".sidebar-badge");o&&o.remove()}}catch(e){console.error("Error loading unread count:",e)}}function q(n){m.channel("global-unread-sync").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${n}`},()=>{U(n)}).subscribe()}document.addEventListener("DOMContentLoaded",async()=>{console.log("Account page specialized logic ready."),H()});function H(){const n=document.getElementById("sidebarLogout");n&&n.addEventListener("click",async o=>{o.preventDefault(),confirm("Are you sure you want to logout?")&&(await S(),window.location.href="index.html")});const e=document.getElementById("avatarInput");e&&e.addEventListener("change",async o=>{console.log("Avatar input changed");const d=o.target.files[0];if(!d){console.log("No file selected");return}if(alert("File selected: "+d.name+" ("+Math.round(d.size/1024)+"KB). Starting upload..."),d.size>2*1024*1024){alert("File size must be less than 2MB");return}try{const u=document.querySelector(".avatar-edit-overlay"),h=u.innerHTML;u.innerHTML='<span style="font-size: 10px;">‚è≥</span>';const{data:{user:b}}=await m.auth.getUser();if(!b)throw new Error("Not authenticated");const I=d.name.split(".").pop(),y=`${Date.now()}.${I}`,c=`${b.id}/${y}`,{error:E}=await m.storage.from("avatars").upload(c,d,{upsert:!0});if(E)throw E;const{data:{publicUrl:w}}=m.storage.from("avatars").getPublicUrl(c),{error:C}=await m.from("profiles").update({avatar_url:w}).eq("id",b.id);if(C)throw C;if(window.syncProfileUI){const a={...b,avatar_url:w};document.getElementById("profileAvatar").src=w,document.getElementById("topNavAvatar").src=w,alert("Profile picture updated!")}else window.location.reload();u.innerHTML=h}catch(u){console.error("Avatar upload failed:",u),alert("Failed to update profile picture: "+u.message),document.querySelector(".avatar-edit-overlay").innerHTML=`
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                `}});const r=document.getElementById("username"),t=document.getElementById("saveProfileBtn"),i=document.getElementById("usernameFeedback");let s="";r&&t&&i&&(r.removeAttribute("readonly"),r.style.cursor="text",r.style.backgroundColor="white",r.addEventListener("focus",()=>{s||(s=r.value)}),r.addEventListener("input",o=>{const d=o.target.value.trim(),u=/^[a-zA-Z0-9_]{3,20}$/.test(d);d===s?(t.style.opacity="0.5",t.style.pointerEvents="none",i.textContent="",r.style.borderColor="#d1d5db"):u?(t.style.opacity="1",t.style.pointerEvents="auto",i.textContent="Looks good! Click save to check availability.",i.style.color="green",r.style.borderColor="green"):(t.style.opacity="0.5",t.style.pointerEvents="none",i.textContent="Username must be 3-20 chars, alphanumeric or underscore.",i.style.color="red",r.style.borderColor="red")}),t.addEventListener("click",async()=>{const o=r.value.trim();t.textContent="Saving...",t.disabled=!0;try{const{data:{user:d}}=await m.auth.getUser();if(!d)throw new Error("Not authenticated");const{error:u}=await m.from("profiles").update({username:o}).eq("id",d.id);if(u)throw u.code==="23505"?new Error("This username is already taken."):u;alert("Username updated successfully!"),s=o,t.textContent="Saved",setTimeout(()=>{t.textContent="Save Changes",t.style.opacity="0.5",t.style.pointerEvents="none"},2e3),window.syncProfileUI&&(document.getElementById("profileFullName").textContent=o,document.getElementById("userName").textContent=o)}catch(d){console.error("Update failed:",d),i.textContent=d.message,i.style.color="red",r.style.borderColor="red",t.textContent="Save Changes",t.disabled=!1}}))}
