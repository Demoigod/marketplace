import{g as I,s as p,b as k}from"./auth-B4SlU3WG.js";document.addEventListener("DOMContentLoaded",async()=>{U(),await _(),N()});function U(){const t=document.getElementById("currentDate");if(t){const e=new Date,c={month:"long",day:"numeric",year:"numeric"};t.textContent=`Today is ${e.toLocaleDateString("en-US",c)}`}}async function _(){const t=await I();t&&(h(t),document.getElementById("countListings")&&F(t.id),(document.getElementById("activityFeed1")||document.getElementById("notificationFeed"))&&$(),document.getElementById("myListingsFeed")&&(B(t.id),T(t.id)),L(t.id),M(t.id))}async function B(t){const e=document.getElementById("myListingsFeed"),c=document.getElementById("myListingsCountBadge");if(e)try{const{data:a,error:l}=await p.from("market_listings").select("title, price, status, created_at").eq("seller_id",t).order("created_at",{ascending:!1});if(l)throw l;c&&(c.textContent=a.length);const s=document.getElementById("countListings");if(s&&(s.textContent=a.length),a.length===0){e.innerHTML=`<div class="p-4 text-center text-gray-500">You haven't posted anything yet.</div>`;return}e.innerHTML=a.map(r=>`
            <div class="activity-item">
                <div class="logo-box" style="background: #F8F9FA; color: var(--primary-color); width: 32px; height: 32px;">
                    <span style="font-size: 0.8rem; font-weight: 800;">ðŸ›’</span>
                </div>
                <div class="act-body">
                    <span class="act-user">${r.title}</span>
                    <span class="act-desc">R ${r.price} â€¢ <span class="status-tag ${r.status}">${r.status.toUpperCase()}</span></span>
                </div>
                <span class="act-time">${new Date(r.created_at).toLocaleDateString()}</span>
            </div>
        `).join("")}catch(a){console.error("Error loading my listings:",a),e.innerHTML='<div class="p-4 text-red-500">Could not load your listings.</div>'}}function T(t){p.channel("my-listings-changes").on("postgres_changes",{event:"*",schema:"public",table:"market_listings",filter:`seller_id=eq.${t}`},e=>{console.log("Real-time listing change detected:",e.eventType),B(t)}).subscribe()}async function F(t){try{const{count:e}=await p.from("market_listings").select("*",{count:"exact",head:!0}).eq("seller_id",t);document.getElementById("countListings").textContent=e||0,document.getElementById("countMessages").textContent="12",document.getElementById("unreadBadge").textContent="6",document.getElementById("countResources").textContent="6",document.getElementById("countSales").textContent="3"}catch(e){console.error("Error loading metrics:",e)}}function $(){const t=document.getElementById("activityFeed1"),e=document.getElementById("activityFeed2"),c=document.getElementById("notificationFeed"),a=[{name:"John Doe",action:"Bought item from seller",time:"30 mins ago"},{name:"Jane Smith",action:"Listed a new textbook",time:"1 hour ago"},{name:"Alex Brown",action:"Commented on your post",time:"2 hours ago"}],l=[{name:"John Doe",desc:"sent you a message",time:"10 mins ago"},{name:"System",desc:"Your document was approved",time:"1 hour ago"},{name:"Market",desc:"New comment on your listing",time:"2 hours ago"}];t&&(t.innerHTML=a.map(s=>x(s)).join("")),e&&(e.innerHTML=a.map(s=>x(s)).join("")),c&&(c.innerHTML=l.map(s=>D(s)).join(""))}function x(t){return`
        <div class="activity-item">
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}&background=random" class="act-avatar">
            <div class="act-body">
                <span class="act-user">${t.name}</span>
                <span class="act-desc">${t.action}</span>
            </div>
            <span class="act-time">${t.time}</span>
        </div>
    `}function D(t){return`
        <div class="activity-item">
            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}&background=F1F3F5&color=368CBF" class="act-avatar" style="border-radius: 8px;">
            <div class="act-body">
                <span class="act-user">${t.name} ${t.desc}</span>
                <span class="act-time">${t.time}</span>
            </div>
            <span style="color: #ADB5BD; font-size: 1.2rem;">...</span>
        </div>
    `}function N(){const t=document.querySelector(".sidebar");if(!t)return;const e=window.location.pathname.split("/").pop()||"admin.html";document.querySelectorAll(".nav-link").forEach(a=>{a.getAttribute("href")===e?a.classList.add("active"):a.classList.remove("active")}),t.addEventListener("click",async a=>{const l=a.target.closest(".nav-link");if(!l)return;if(l.id==="sidebarLogout"){a.preventDefault(),A();return}const s=l.getAttribute("href");if(s==="#"||!s){a.preventDefault();return}const{data:{session:r}}=await p.auth.getSession();if(!r&&s!=="index.html"){a.preventDefault(),window.location.href="index.html";return}});const c=document.getElementById("profileToggle");c&&c.addEventListener("click",()=>{window.location.href="account.html"}),h()}async function h(t=null){console.log("--- SYNC ATTEMPT START ---");try{const e=t||await I();if(!e){console.warn("Sync aborted: User object not found.");return}const c=()=>{var C,E,w;const a=String(e.first_name||((C=e.user_metadata)==null?void 0:C.first_name)||""),l=String(e.last_name||((E=e.user_metadata)==null?void 0:E.last_name)||""),s=String(e.username||((w=e.user_metadata)==null?void 0:w.username)||"User"),r=String(e.email||""),S=String(e.phone||e.phone_number||""),b=String(e.immutable_user_code||(e.id?e.id.slice(0,6).toUpperCase():"000000"));let g=s;a&&(g=`${a} ${l}`.trim()),g==="User"&&a&&(g=`${a} ${l}`.trim());const v=e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(g)}&background=368CBF&color=fff`;[{id:"userName",attr:"textContent",val:g},{id:"welcomeTitle",attr:"textContent",val:`Welcome, ${a||s} ðŸ‘‹`},{id:"userId",attr:"textContent",val:`ID: ${b}`},{id:"profileFullName",attr:"textContent",val:g},{id:"profileRole",attr:"textContent",val:(e.role||"Member").charAt(0).toUpperCase()+(e.role||"Member").slice(1)},{id:"publicUserIdDisplay",attr:"textContent",val:`ID: #${b}`},{id:"topNavAvatar",attr:"src",val:v},{id:"userAvatar",attr:"src",val:v},{id:"profileAvatar",attr:"src",val:v},{id:"firstName",attr:"value",val:a},{id:"lastName",attr:"value",val:l},{id:"username",attr:"value",val:s},{id:"email",attr:"value",val:r},{id:"phone",attr:"value",val:S}].forEach(n=>{const d=document.getElementById(n.id);d&&(n.attr==="value"?(d.value=n.val,d.placeholder=n.val||"Not provided"):d[n.attr]=n.val)});const y=document.getElementById("profileAvatar");if(y&&!y.closest(".avatar-upload-wrapper")){console.log("Detected cached HTML: Injecting Avatar Upload UI...");const n=document.createElement("div");n.className="avatar-upload-wrapper",n.style.position="relative",n.style.display="inline-block";const d=y.cloneNode(!0);n.appendChild(d);const u=document.createElement("label");u.className="avatar-edit-overlay",u.htmlFor="avatarInput",u.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',n.appendChild(u);const o=document.createElement("input");if(o.type="file",o.id="avatarInput",o.accept="image/*",o.style.display="none",n.appendChild(o),y.parentNode.insertBefore(n,y),y.remove(),!document.getElementById("avatar-styles")){const m=document.createElement("style");m.id="avatar-styles",m.textContent=`
                        .avatar-edit-overlay { position: absolute; bottom: 0; right: 0; background: #368CBF; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; transition: transform 0.2s; }
                        .avatar-edit-overlay:hover { transform: scale(1.1); }
                    `,document.head.appendChild(m)}}const i=document.getElementById("username");if(i&&i.hasAttribute("readonly")&&document.querySelector(".profile-form")){if(console.log("Detected cached HTML: Injecting Username Edit UI..."),i.removeAttribute("readonly"),i.placeholder="Choose a unique username",i.autocomplete="off",i.classList.add("editable-username"),!document.getElementById("usernameFeedback")){const o=document.createElement("small");o.id="usernameFeedback",o.style.display="block",o.style.marginTop="4px",o.style.fontSize="0.75rem",o.style.minHeight="1.2em",i.parentNode.appendChild(o)}if(!document.getElementById("saveProfileBtn")){const o=document.createElement("div");o.className="form-actions",o.style.marginTop="0.5rem",o.style.textAlign="right",o.innerHTML='<button id="saveProfileBtn" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 6px; border: none; background: #368CBF; color: white; font-weight: 600; cursor: pointer; opacity: 0.5; pointer-events: none; transition: opacity 0.2s;">Save Changes</button>',i.parentNode.parentNode.appendChild(o),i.parentNode.after(o)}const n=document.getElementById("saveProfileBtn"),d=document.getElementById("usernameFeedback");let u=i.value;i.addEventListener("focus",()=>{u||(u=i.value)}),i.addEventListener("input",o=>{const m=o.target.value.trim(),f=/^[a-zA-Z0-9_]{3,20}$/.test(m);m===u?(n.style.opacity="0.5",n.style.pointerEvents="none",d.textContent="",i.style.borderColor="#d1d5db"):f?(n.style.opacity="1",n.style.pointerEvents="auto",d.textContent="Looks good!",d.style.color="green",i.style.borderColor="green"):(n.style.opacity="0.5",n.style.pointerEvents="none",d.textContent="Invalid format (3-20 chars, alphanumeric/_)",d.style.color="red",i.style.borderColor="red")}),n.addEventListener("click",async()=>{const o=i.value.trim();n.textContent="Saving...",n.disabled=!0;try{const{data:{user:m}}=await p.auth.getUser();if(!m)throw new Error("Not logged in");const{error:f}=await p.from("profiles").update({username:o}).eq("id",m.id);if(f)throw f.code==="23505"?new Error("Username taken"):f;alert("Username updated!"),u=o,n.textContent="Saved",setTimeout(()=>{n.textContent="Save Changes",n.style.opacity="0.5",n.style.pointerEvents="none"},2e3)}catch(m){alert(m.message),n.textContent="Save Changes",n.disabled=!1}})}console.log("--- SYNC SUCCESSFUL ---")};c(),setTimeout(c,300)}catch(e){console.error("CRITICAL ERROR during Profile UI sync:",e)}}window.syncProfileUI=h;async function A(){if(confirm("Are you sure you want to logout?"))try{await k(),window.location.href="index.html"}catch(t){console.error("Logout failed:",t),window.location.href="index.html"}}async function L(t){try{const{count:e,error:c}=await p.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_id",t).is("read_at",null);if(c)throw c;const a=document.getElementById("unreadBadge");a&&(a.textContent=e||0,a.style.display=e>0?"flex":"none");const l=document.getElementById("countMessages");l&&(l.textContent=e||0);const s=document.querySelector('a[href="messages.html"]');if(s&&e>0){let r=s.querySelector(".sidebar-badge");r||(r=document.createElement("span"),r.className="sidebar-badge",r.style="background: #E63946; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto; font-weight: 700;",s.appendChild(r)),r.textContent=e}else if(s){const r=s.querySelector(".sidebar-badge");r&&r.remove()}}catch(e){console.error("Error loading unread count:",e)}}function M(t){p.channel("global-unread-sync").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${t}`},()=>{L(t)}).subscribe()}
