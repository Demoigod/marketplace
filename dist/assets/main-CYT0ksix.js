import{i as d,g as b,s as i,a as x}from"./navbar-CJGh-4aH.js";/* empty css               */import{h as _}from"./contact-seller-DIK6gRHY.js";async function R(e){var c;if(e.preventDefault(),!await d()){alert("Please log in to post an item."),document.dispatchEvent(new CustomEvent("open-auth-modal"));return}const o=await b();if(!o)return;const t=e.target,r=t.querySelector("#itemTitle").value,s=parseFloat(t.querySelector("#itemPrice").value),a=t.querySelector("#itemDescription").value,n=t.querySelector("#itemCategory").value,u=["https://placeholder.com/600x400"];if(!r||isNaN(s)||!a){alert("Please fill in all required fields.");return}try{const{data:l,error:m}=await i.from("items").insert([{user_id:o.id,title:r,description:a,price:s,images:u,category:n,condition:((c=t.querySelector("#itemCondition"))==null?void 0:c.value)||"good"}]).select().single();if(m)throw m;console.log("Item posted successfully:",l),alert("Your item is now live!"),t.reset();const p=document.getElementById("uploadModal");p&&p.classList.remove("active"),document.dispatchEvent(new CustomEvent("item-posted"))}catch(l){console.error("Error posting item:",l.message),alert("Error: "+l.message)}}async function F(e){if(e.preventDefault(),!await d()){alert("Please log in to upload resources."),document.dispatchEvent(new CustomEvent("open-auth-modal"));return}const o=await b();if(!o)return;const t=e.target,r=t.querySelector("#resourceTitle").value,s=t.querySelector("#resourceType").value,a=t.querySelector("#resourceCourse").value,n=parseInt(t.querySelector("#resourceYear").value)||new Date().getFullYear(),u=t.querySelector("#resourceDescription").value;if(!r||!s||!a){alert("Please fill in required fields (Title, Type, Course).");return}try{const{data:c,error:l}=await i.from("free_resources").insert([{uploader_id:o.id,title:r,type:s,course:a,year:n,description:u}]).select().single();if(l)throw l;console.log("Resource uploaded successfully:",c),alert("Resource uploaded successfully!"),t.reset();const m=document.getElementById("resourceModal");m&&m.classList.remove("active"),document.getElementById("resourcesGrid")&&window.location.reload()}catch(c){console.error("Error uploading resource:",c.message),alert("Error: "+c.message)}}async function H(){try{const{data:e,error:o}=await i.from("items").select("*").order("created_at",{ascending:!1});if(o)throw o;return e||[]}catch(e){return console.error("Error fetching items:",e),[]}}function A(e,o=!1){const t=new Date(e.created_at).toLocaleDateString(),r=e.images&&e.images.length>0?e.images[0]:"https://via.placeholder.com/300x200",s=o?"":"disabled",a=o?"":'title="Please login to use this feature"';return`
        <div class="marketplace-item" data-id="${e.id}" data-user-id="${e.user_id}">
            <div class="item-image" style="background-image: url('${r}'); background-size: cover; background-position: center;"></div>
            <div class="item-content">
                <div class="item-header">
                    <h3 class="item-title">${M(e.title)}</h3>
                    <span class="item-price">$${parseFloat(e.price).toFixed(2)}</span>
                </div>
                <p class="item-date">Posted on ${t}</p>
                <p class="item-description">${M(e.description)}</p>
                
                <div class="item-actions-grid">
                    <button class="btn-buy" ${s} ${a} onclick="handleBuyAction('${e.id}')">Buy</button>
                    <button class="btn-contact" ${s} ${a} onclick="handleContactAction('${e.user_id}')">Contact Seller</button>
                    <button class="btn-view" onclick="window.location.href='item.html?id=${e.id}'">View</button>
                    <button class="btn-save" data-item-id="${e.id}">Save</button>
                </div>
            </div>
        </div>
    `}window.handleBuyAction=e=>{window.location.href=`payment.html?item_id=${e}`};window.handleContactAction=e=>{_(e)};function M(e){const o=document.createElement("div");return o.textContent=e,o.innerHTML}async function P(e){if(!await d()){alert("Please log in to save items."),document.dispatchEvent(new CustomEvent("open-auth-modal"));return}const o=await b();if(o)try{const{data:t,error:r}=await i.from("saved_items").select("id").eq("user_id",o.id).eq("item_id",e).maybeSingle();if(r)throw r;if(t){const{error:s}=await i.from("saved_items").delete().eq("id",t.id);if(s)throw s;return{saved:!1,message:"Item removed from bookmarks"}}else{const{error:s}=await i.from("saved_items").insert([{user_id:o.id,item_id:e}]);if(s)throw s;return{saved:!0,message:"Item saved successfully!"}}}catch(t){throw console.error("Save error:",t),t}}function D(){document.addEventListener("click",async e=>{if(e.target.classList.contains("btn-save")){const o=e.target.dataset.itemId,t=e.target;t.disabled=!0;try{const r=await P(o);t.classList.toggle("active",r.saved),t.textContent=r.saved?"Saved":"Save",console.log(r.message)}catch{alert("Failed to save item.")}finally{t.disabled=!1}}})}let E="all",L="all",T=[];const h=document.getElementById("uploadModal"),B=document.getElementById("resourceModal"),g=document.getElementById("authModal"),C=document.getElementById("uploadResourceBtn"),G=document.getElementById("closeModal"),j=document.getElementById("closeResourceModal"),N=document.getElementById("closeAuthModal"),S=document.getElementById("uploadForm"),$=document.getElementById("resourceForm"),q=document.getElementById("searchInput"),v=document.getElementById("marketplaceGrid"),k=document.getElementById("resourcesGrid");document.addEventListener("DOMContentLoaded",async()=>{await x(),await f(),I(),D(),new URLSearchParams(window.location.search).get("action")==="post"&&setTimeout(()=>{document.dispatchEvent(new CustomEvent("open-post-modal"))},500),Y()});async function f(){if(!v)return;v.innerHTML='<div class="loading-state">Loading marketplace...</div>';const e=await d(),o=await H(),t=E==="all"?o:o.filter(r=>r.category===E);if(t.length===0){v.innerHTML='<div class="empty-state">No items found in this category.</div>';return}v.innerHTML=t.map(r=>A(r,e)).join("")}document.addEventListener("item-posted",()=>{f()});async function I(){if(k)try{let e=i.from("free_resources").select("*");L!=="all"&&(e=e.eq("type",L));const{data:o,error:t}=await e.order("created_at",{ascending:!1});if(t)throw t;T=o||[],z()}catch(e){console.error("Error fetching resources:",e.message)}}function z(){k&&(k.innerHTML=T.map(e=>U(e)).join(""))}function U(e){const o={exam:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/></svg>',textbook:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2"/></svg>',notes:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2"/></svg>'};return`
        <div class="resource-card" data-id="${e.id}">
            <div class="resource-header">
                <div class="resource-icon">${o[e.type]||o.exam}</div>
                <div class="resource-info">
                    <span class="resource-type">${e.type}</span>
                    <h3 class="resource-title">${e.title}</h3>
                    <p class="resource-course">${e.course}</p>
                </div>
            </div>
            <div class="resource-meta">
                <span class="resource-year">${e.year}</span>
                <button class="download-btn" onclick="downloadResourceAction('${e.id}')">Download</button>
            </div>
        </div>
    `}function Y(){document.addEventListener("open-auth-modal",()=>{g&&y(g)}),document.addEventListener("open-post-modal",async()=>{if(!await d()){document.dispatchEvent(new CustomEvent("open-auth-modal"));return}h&&y(h)});const e=document.getElementById("postItemBtn");e&&e.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("open-post-modal"))}),C&&C.addEventListener("click",async()=>{if(!await d()){document.dispatchEvent(new CustomEvent("open-auth-modal"));return}y(B)}),[G,j,N].forEach(o=>{o&&(o.onclick=()=>{w(h),w(B),w(g)})}),document.querySelectorAll(".category-chip").forEach(o=>{o.addEventListener("click",t=>{document.querySelectorAll(".category-chip").forEach(r=>r.classList.remove("active")),t.target.classList.add("active"),E=t.target.dataset.category,f()})}),document.querySelectorAll(".resource-chip").forEach(o=>{o.addEventListener("click",t=>{document.querySelectorAll(".resource-chip").forEach(r=>r.classList.remove("active")),t.target.classList.add("active"),L=t.target.dataset.type,I()})}),q&&q.addEventListener("input",O(V,300)),S&&S.addEventListener("submit",R),$&&$.addEventListener("submit",F),document.querySelectorAll(".auth-tab").forEach(o=>{o.addEventListener("click",t=>{const r=t.target.dataset.tab;document.querySelectorAll(".auth-tab").forEach(u=>u.classList.remove("active")),t.target.classList.add("active");const s=document.getElementById("loginForm"),a=document.getElementById("registerForm"),n=document.getElementById("authModalTitle");r==="login"?(s&&(s.style.display="block"),a&&(a.style.display="none"),n&&(n.textContent="Login")):(s&&(s.style.display="none"),a&&(a.style.display="block"),n&&(n.textContent="Register"))})})}async function V(e){const o=e.target.value.toLowerCase().trim();if(!o){f(),I();return}try{const{data:t,error:r}=await i.from("items").select("*").or(`title.ilike.%${o}%,description.ilike.%${o}%,category.ilike.%${o}%`).eq("status","active");if(!r&&t){const s=await d();v.innerHTML=t.map(a=>A(a,s)).join("")}}catch(t){console.error("Search error:",t)}}function y(e){e&&(e.classList.add("active"),document.body.style.overflow="hidden")}function w(e){e&&(e.classList.remove("active"),document.body.style.overflow="")}function O(e,o){let t;return function(...s){const a=()=>{clearTimeout(t),e(...s)};clearTimeout(t),t=setTimeout(a,o)}}window.downloadResourceAction=e=>{alert("Resource download started!")};
