{"version":3,"file":"post-item-BQiELlFE.js","sources":["../../post-item.js","../../post-item.html?html-proxy&index=3.js"],"sourcesContent":["import { supabase } from './supabase-config.js';\r\nimport { isLoggedIn, logoutUser, getCurrentUser } from './auth.js';\r\n\r\nlet selectedFiles = [];\r\n\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n    // 1. Auth Guard\r\n    const loggedIn = await isLoggedIn();\r\n    if (!loggedIn) {\r\n        window.location.href = 'index.html';\r\n        return;\r\n    }\r\n\r\n    // 2. Initialize Page\r\n    setupEventListeners();\r\n});\r\n\r\n\r\nfunction setupEventListeners() {\r\n    const imageInput = document.getElementById('imageInput');\r\n    const imageGrid = document.getElementById('imageGrid');\r\n    const postForm = document.getElementById('postItemForm');\r\n    const logoutBtn = document.querySelector('.logout-btn');\r\n\r\n    // Image Upload Handling\r\n    imageInput.addEventListener('change', (e) => {\r\n        const files = Array.from(e.target.files);\r\n        if (selectedFiles.length + files.length > 5) {\r\n            alert('You can only upload up to 5 images.');\r\n            return;\r\n        }\r\n\r\n        files.forEach(file => {\r\n            selectedFiles.push(file);\r\n            renderPreview(file);\r\n        });\r\n\r\n        imageInput.value = ''; // Reset input to allow re-selecting same file\r\n    });\r\n\r\n    // Form Submission\r\n    postForm.addEventListener('submit', async (e) => {\r\n        e.preventDefault();\r\n        const submitBtn = document.getElementById('submitBtn');\r\n        submitBtn.disabled = true;\r\n        submitBtn.textContent = 'Posting...';\r\n\r\n        try {\r\n            const user = await getCurrentUser();\r\n            if (!user) throw new Error('Authentication required');\r\n\r\n            // 1. Upload Images\r\n            const imageUrls = await uploadImages(user.id);\r\n\r\n            // 2. Submit to Database\r\n            const itemData = {\r\n                seller_id: user.id, // Immutable UUID from session\r\n                seller_public_id: user.publicUserId || null, // 6-digit public ID\r\n                title: document.getElementById('title').value,\r\n                description: document.getElementById('description').value,\r\n                price: parseFloat(document.getElementById('price').value),\r\n                category: document.getElementById('category').value,\r\n                image_url: imageUrls[0] || null, // Primary image\r\n                images: imageUrls, // All images\r\n                status: 'active'\r\n            };\r\n\r\n            const { data, error } = await supabase\r\n                .from('market_listings')\r\n                .insert([itemData])\r\n                .select();\r\n\r\n            if (error) throw error;\r\n\r\n            alert('Item posted successfully!');\r\n            window.location.href = 'listings.html';\r\n\r\n        } catch (err) {\r\n            console.error('Post error:', err);\r\n            alert(`Error: ${err.message}`);\r\n            submitBtn.disabled = false;\r\n            submitBtn.textContent = 'List Item Now';\r\n        }\r\n    });\r\n\r\n}\r\n\r\nfunction renderPreview(file) {\r\n    const grid = document.getElementById('imageGrid');\r\n    const uploadBtn = document.getElementById('uploadBtn');\r\n\r\n    const div = document.createElement('div');\r\n    div.className = 'image-preview-box';\r\n\r\n    const img = document.createElement('img');\r\n    img.src = URL.createObjectURL(file);\r\n\r\n    const removeBtn = document.createElement('button');\r\n    removeBtn.className = 'remove-img';\r\n    removeBtn.textContent = 'Ã—';\r\n    removeBtn.onclick = () => {\r\n        selectedFiles = selectedFiles.filter(f => f !== file);\r\n        div.remove();\r\n    };\r\n\r\n    div.appendChild(img);\r\n    div.appendChild(removeBtn);\r\n    grid.insertBefore(div, uploadBtn);\r\n}\r\n\r\nasync function uploadImages(userId) {\r\n    const urls = [];\r\n\r\n    for (const file of selectedFiles) {\r\n        const fileExt = file.name.split('.').pop();\r\n        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;\r\n        const filePath = `${userId}/${fileName}`;\r\n\r\n        const { error: uploadError } = await supabase.storage\r\n            .from('listing-images')\r\n            .upload(filePath, file);\r\n\r\n        if (uploadError) throw uploadError;\r\n\r\n        const { data: { publicUrl } } = supabase.storage\r\n            .from('listing-images')\r\n            .getPublicUrl(filePath);\r\n\r\n        urls.push(publicUrl);\r\n    }\r\n\r\n    return urls;\r\n}\r\n","\n        import { getCurrentUser } from './auth.js';\n\n        // Protect Post Item Page\n        (async () => {\n            const user = await getCurrentUser();\n            if (!user || user.role !== 'seller') {\n                window.location.href = 'index.html';\n            }\n        })();\n    "],"names":["selectedFiles","isLoggedIn","setupEventListeners","imageInput","postForm","e","files","file","renderPreview","submitBtn","user","getCurrentUser","imageUrls","uploadImages","itemData","data","error","supabase","err","grid","uploadBtn","div","img","removeBtn","f","userId","urls","fileExt","fileName","filePath","uploadError","publicUrl"],"mappings":"6GAGA,IAAIA,EAAgB,CAAA,EAEpB,SAAS,iBAAiB,mBAAoB,SAAY,CAGtD,GAAI,CADa,MAAMC,IACR,CACX,OAAO,SAAS,KAAO,aACvB,MACJ,CAGAC,GACJ,CAAC,EAGD,SAASA,GAAsB,CAC3B,MAAMC,EAAa,SAAS,eAAe,YAAY,EACrC,SAAS,eAAe,WAAW,EACrD,MAAMC,EAAW,SAAS,eAAe,cAAc,EACrC,SAAS,cAAc,aAAa,EAGtDD,EAAW,iBAAiB,SAAWE,GAAM,CACzC,MAAMC,EAAQ,MAAM,KAAKD,EAAE,OAAO,KAAK,EACvC,GAAIL,EAAc,OAASM,EAAM,OAAS,EAAG,CACzC,MAAM,qCAAqC,EAC3C,MACJ,CAEAA,EAAM,QAAQC,GAAQ,CAClBP,EAAc,KAAKO,CAAI,EACvBC,EAAcD,CAAI,CACtB,CAAC,EAEDJ,EAAW,MAAQ,EACvB,CAAC,EAGDC,EAAS,iBAAiB,SAAU,MAAOC,GAAM,CAC7CA,EAAE,eAAc,EAChB,MAAMI,EAAY,SAAS,eAAe,WAAW,EACrDA,EAAU,SAAW,GACrBA,EAAU,YAAc,aAExB,GAAI,CACA,MAAMC,EAAO,MAAMC,IACnB,GAAI,CAACD,EAAM,MAAM,IAAI,MAAM,yBAAyB,EAGpD,MAAME,EAAY,MAAMC,EAAaH,EAAK,EAAE,EAGtCI,EAAW,CACb,UAAWJ,EAAK,GAChB,iBAAkBA,EAAK,cAAgB,KACvC,MAAO,SAAS,eAAe,OAAO,EAAE,MACxC,YAAa,SAAS,eAAe,aAAa,EAAE,MACpD,MAAO,WAAW,SAAS,eAAe,OAAO,EAAE,KAAK,EACxD,SAAU,SAAS,eAAe,UAAU,EAAE,MAC9C,UAAWE,EAAU,CAAC,GAAK,KAC3B,OAAQA,EACR,OAAQ,QACxB,EAEkB,CAAE,KAAAG,EAAM,MAAAC,CAAK,EAAK,MAAMC,EACzB,KAAK,iBAAiB,EACtB,OAAO,CAACH,CAAQ,CAAC,EACjB,SAEL,GAAIE,EAAO,MAAMA,EAEjB,MAAM,2BAA2B,EACjC,OAAO,SAAS,KAAO,eAE3B,OAASE,EAAK,CACV,QAAQ,MAAM,cAAeA,CAAG,EAChC,MAAM,UAAUA,EAAI,OAAO,EAAE,EAC7BT,EAAU,SAAW,GACrBA,EAAU,YAAc,eAC5B,CACJ,CAAC,CAEL,CAEA,SAASD,EAAcD,EAAM,CACzB,MAAMY,EAAO,SAAS,eAAe,WAAW,EAC1CC,EAAY,SAAS,eAAe,WAAW,EAE/CC,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,UAAY,oBAEhB,MAAMC,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,IAAM,IAAI,gBAAgBf,CAAI,EAElC,MAAMgB,EAAY,SAAS,cAAc,QAAQ,EACjDA,EAAU,UAAY,aACtBA,EAAU,YAAc,IACxBA,EAAU,QAAU,IAAM,CACtBvB,EAAgBA,EAAc,OAAOwB,GAAKA,IAAMjB,CAAI,EACpDc,EAAI,OAAM,CACd,EAEAA,EAAI,YAAYC,CAAG,EACnBD,EAAI,YAAYE,CAAS,EACzBJ,EAAK,aAAaE,EAAKD,CAAS,CACpC,CAEA,eAAeP,EAAaY,EAAQ,CAChC,MAAMC,EAAO,CAAA,EAEb,UAAWnB,KAAQP,EAAe,CAC9B,MAAM2B,EAAUpB,EAAK,KAAK,MAAM,GAAG,EAAE,MAC/BqB,EAAW,GAAG,KAAK,IAAG,CAAE,IAAI,KAAK,OAAM,EAAG,SAAS,EAAE,EAAE,UAAU,CAAC,CAAC,IAAID,CAAO,GAC9EE,EAAW,GAAGJ,CAAM,IAAIG,CAAQ,GAEhC,CAAE,MAAOE,GAAgB,MAAMb,EAAS,QACzC,KAAK,gBAAgB,EACrB,OAAOY,EAAUtB,CAAI,EAE1B,GAAIuB,EAAa,MAAMA,EAEvB,KAAM,CAAE,KAAM,CAAE,UAAAC,CAAS,CAAE,EAAKd,EAAS,QACpC,KAAK,gBAAgB,EACrB,aAAaY,CAAQ,EAE1BH,EAAK,KAAKK,CAAS,CACvB,CAEA,OAAOL,CACX,EChIS,SAAY,CACT,MAAMhB,EAAO,MAAMC,EAAc,GAC7B,CAACD,GAAQA,EAAK,OAAS,YACvB,OAAO,SAAS,KAAO,aAE/B,GAAC"}