<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Details - Campus Market</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <!-- Navigation rendered by navbar.js -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content"></div>
        </div>
    </nav>

    <main class="container" style="margin-top: 2rem;">
        <div id="itemDetailContainer" class="item-detail-layout">
            <div class="loading-state">Loading item details...</div>
        </div>
    </main>

    <script type="module">
        import { supabase } from './supabase-config.js';
        import { initNavigation } from './navbar.js';
        import { isLoggedIn } from './auth.js';

        document.addEventListener('DOMContentLoaded', async () => {
            await initNavigation();
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('id');

            if (!itemId) {
                window.location.href = 'index.html';
                return;
            }

            loadItemDetails(itemId);
        });

        async function loadItemDetails(id) {
            const container = document.getElementById('itemDetailContainer');
            const isAuth = await isLoggedIn();

            try {
                const { data: item, error } = await supabase
                    .from('market_listings')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error || !item) throw new Error('Item not found');

                const mainImage = item.images && item.images.length > 0 ? item.images[0] : 'https://via.placeholder.com/600x400';

                container.innerHTML = `
                    <div class="item-detail-grid">
                        <div class="item-visuals">
                            <img src="${mainImage}" alt="${item.title}" class="main-detail-image">
                        </div>
                        <div class="item-info-panel">
                            <h1 class="detail-title">${item.title}</h1>
                            <div class="detail-meta">
                                <span class="detail-price">$${parseFloat(item.price).toFixed(2)}</span>
                                <span class="detail-date">Posted ${new Date(item.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-description">
                                <h3>Description</h3>
                                <p>${item.description}</p>
                            </div>
                            <div class="detail-actions">
                                <button class="btn-primary btn-full ${isAuth ? '' : 'disabled'}" onclick="handleBuyAction('${item.id}')">Buy Now</button>
                                <button class="btn-secondary btn-full ${isAuth ? '' : 'disabled'}" onclick="handleContactAction('${item.seller_id}')">Contact Seller</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = `<div class="error-state">${err.message}</div>`;
            }
        }

        window.handleBuyAction = (itemId) => {
            window.location.href = `payment.html?item_id=${itemId}`;
        };

        window.handleContactAction = (sellerId) => {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('id');
            window.location.href = `messages.html?seller_id=${sellerId}&listing_id=${itemId}`;
        };
    </script>
</body>

</html>